#!/usr/bin/env node

/**
 * Generate Team Reports - Discipline-Specific Daily Reports
 *
 * Reads daily metrics JSON and generates markdown reports per discipline.
 * Used by daily-status-report factory for team-specific reporting.
 */

const fs = require("fs");
const path = require("path");

/**
 * Load latest daily metrics JSON
 * @returns {Object} Daily metrics data
 */
function loadLatestMetrics() {
  const runsDir = path.join(process.cwd(), ".ralph", "factory", "runs");

  if (!fs.existsSync(runsDir)) {
    console.error(`[Error] Runs directory not found: ${runsDir}`);
    process.exit(1);
  }

  // Find all daily-metrics-*.json files
  const files = fs
    .readdirSync(runsDir)
    .filter((f) => f.startsWith("daily-metrics-") && f.endsWith(".json"))
    .sort()
    .reverse(); // Most recent first

  if (files.length === 0) {
    console.error("[Error] No daily metrics found. Run aggregate-game-metrics.js first.");
    process.exit(1);
  }

  const latestFile = path.join(runsDir, files[0]);
  console.log(`  Loading metrics from: ${latestFile}`);

  try {
    const content = fs.readFileSync(latestFile, "utf-8");
    return JSON.parse(content);
  } catch (error) {
    console.error(`[Error] Failed to parse metrics file: ${error.message}`);
    process.exit(1);
  }
}

/**
 * Generate markdown report for a discipline
 * @param {string} discipline - Discipline name
 * @param {Object} data - Discipline metrics
 * @param {Object} totals - Studio-wide totals
 * @param {Object[]} blockers - Blocked PRDs
 * @param {string} timestamp - Report timestamp
 * @returns {string} Markdown report content
 */
function generateDisciplineReport(discipline, data, totals, blockers, timestamp) {
  const disciplineBlockers = blockers.filter((b) => b.discipline === discipline);

  let report = `# ${discipline.charAt(0).toUpperCase() + discipline.slice(1)} Daily Report\n\n`;
  report += `**Generated:** ${new Date(timestamp).toLocaleString()}\n\n`;
  report += `---\n\n`;

  // Metrics Summary
  report += `## Metrics Summary\n\n`;
  report += `| Metric | Value |\n`;
  report += `|--------|-------|\n`;
  report += `| **Total Runs** | ${data.totalRuns} |\n`;
  report += `| **Successful** | ${data.successfulRuns} |\n`;
  report += `| **Failed** | ${data.failedRuns} |\n`;
  report += `| **Success Rate** | ${data.successRate}% |\n`;
  report += `| **Projects** | ${data.projects.join(", ")} |\n\n`;

  // Studio-Wide Comparison
  report += `## Studio Comparison\n\n`;
  report += `| Metric | ${discipline} | Studio Average |\n`;
  report += `|--------|---------------|----------------|\n`;
  report += `| **Success Rate** | ${data.successRate}% | ${totals.successRate}% |\n`;
  report += `| **Runs** | ${data.totalRuns} | ${totals.totalRuns} |\n\n`;

  // Blockers
  if (disciplineBlockers.length > 0) {
    report += `## ⚠️ Blockers (Zero Velocity)\n\n`;
    report += `**WARNING:** ${disciplineBlockers.length} PRD(s) with zero activity detected.\n\n`;
    report += `| PRD | Project | Last Activity | Days Since |\n`;
    report += `|-----|---------|---------------|------------|\n`;

    for (const blocker of disciplineBlockers) {
      report += `| ${blocker.prdId} | ${blocker.projectName} | ${blocker.lastActivity} | ${blocker.daysSinceActivity} days |\n`;
    }

    report += `\n`;
  } else {
    report += `## ✅ No Blockers\n\n`;
    report += `All PRDs in this discipline are actively progressing.\n\n`;
  }

  // Top Contributors (placeholder)
  report += `## Top Contributors\n\n`;
  report += `_Contributor tracking coming soon._\n\n`;

  report += `---\n\n`;
  report += `_Report generated by Ralph Automation System_\n`;

  return report;
}

/**
 * Main execution
 */
async function main() {
  console.log("=".repeat(60));
  console.log("  Generate Team Reports - Discipline-Specific Reports");
  console.log("=".repeat(60));

  // Load metrics
  console.log("[1/3] Loading latest daily metrics...");
  const metrics = loadLatestMetrics();
  console.log(`  Loaded metrics for ${metrics.disciplines.length} disciplines`);

  // Generate reports
  console.log("[2/3] Generating discipline reports...");
  const reportsDir = path.join(process.cwd(), ".ralph", "reports");
  const timestamp = new Date().toISOString();
  const dateStr = timestamp.split("T")[0];

  let reportsGenerated = 0;

  for (const discipline of metrics.disciplines) {
    const reportContent = generateDisciplineReport(
      discipline.discipline,
      discipline,
      metrics.totals,
      metrics.blockers || [],
      metrics.timestamp
    );

    const reportPath = path.join(reportsDir, `${discipline.discipline}-daily-${dateStr}.md`);
    fs.writeFileSync(reportPath, reportContent);

    console.log(`  Generated: ${path.basename(reportPath)}`);
    reportsGenerated++;
  }

  // Generate all-teams summary
  console.log("[3/3] Generating all-teams summary...");
  let summaryReport = `# All Teams Daily Summary\n\n`;
  summaryReport += `**Generated:** ${new Date(metrics.timestamp).toLocaleString()}\n\n`;
  summaryReport += `---\n\n`;

  summaryReport += `## Studio-Wide Metrics\n\n`;
  summaryReport += `| Metric | Value |\n`;
  summaryReport += `|--------|-------|\n`;
  summaryReport += `| **Total Runs** | ${metrics.totals.totalRuns} |\n`;
  summaryReport += `| **Success Rate** | ${metrics.totals.successRate}% |\n`;
  summaryReport += `| **Stories Completed** | ${metrics.totals.storiesCompleted} |\n`;
  summaryReport += `| **Total Cost** | $${metrics.totals.totalCost} |\n`;
  summaryReport += `| **Blockers** | ${(metrics.blockers || []).length} PRDs |\n\n`;

  summaryReport += `## By Discipline\n\n`;
  summaryReport += `| Discipline | Runs | Success Rate | Projects |\n`;
  summaryReport += `|-----------|------|--------------|----------|\n`;

  for (const discipline of metrics.disciplines) {
    summaryReport += `| ${discipline.discipline} | ${discipline.totalRuns} | ${discipline.successRate}% | ${discipline.projects.length} |\n`;
  }

  summaryReport += `\n---\n\n`;
  summaryReport += `_View individual discipline reports for detailed breakdowns._\n`;

  const summaryPath = path.join(reportsDir, `all-teams-daily-${dateStr}.md`);
  fs.writeFileSync(summaryPath, summaryReport);
  console.log(`  Generated: ${path.basename(summaryPath)}`);

  console.log("=".repeat(60));
  console.log("  Summary");
  console.log("=".repeat(60));
  console.log(`  Discipline Reports: ${reportsGenerated}`);
  console.log(`  All-Teams Summary: 1`);
  console.log(`  Total Reports: ${reportsGenerated + 1}`);
  console.log("=".repeat(60));

  process.exit(0);
}

// Execute if run directly
if (require.main === module) {
  main().catch((error) => {
    console.error("[Fatal Error]", error.message);
    console.error(error.stack);
    process.exit(1);
  });
}

module.exports = { main, generateDisciplineReport };
