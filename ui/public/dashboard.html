<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/favicon.png">
  <title>Ralph CLI - Dashboard</title>
  <link rel="stylesheet" href="/css/rams-ui.css">
  <script src="/js/htmx.min.js"></script>
  <script src="/js/htmx-ext-sse.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="rams-page" hx-ext="sse" sse-connect="/api/events">

  <script src="/js/sidebar.js"></script>

  <!-- Persistent Sidebar -->
  <aside class="rams-sidebar" id="rams-sidebar">
    <div class="rams-sidebar-header">
      <div class="rams-logo">
        <div class="rams-logo-mark" onclick="toggleSidebar()" title="Toggle sidebar"></div>
        <span class="rams-logo-text">RALPH</span>
      </div>
    </div>

    <nav class="rams-nav">
      <div class="rams-nav-section">
        <div class="rams-nav-label">Main</div>
        <ul class="rams-nav-items">
          <li><a href="/" class="rams-nav-link">Home</a></li>
          <li><a href="/dashboard.html" class="rams-nav-link active">Dashboard</a></li>
          <li><a href="/streams.html" class="rams-nav-link">Streams</a></li>
          <li><a href="/kanban.html" class="rams-nav-link">Mission Control</a></li>
          <li><a href="/docs/" class="rams-nav-link">Documentation</a></li>
        </ul>
      </div>

      <div class="rams-nav-section">
        <div class="rams-nav-label">Monitoring</div>
        <ul class="rams-nav-items">
          <li><a href="/logs.html" class="rams-nav-link">Logs</a></li>
          <li><a href="/tokens.html" class="rams-nav-link">Tokens</a></li>
          <li><a href="/trends.html" class="rams-nav-link">Trends</a></li>
        </ul>
      </div>

      <div class="rams-nav-section">
        <div class="rams-nav-label">Tools</div>
        <ul class="rams-nav-items">
          <li><a href="/editor.html" class="rams-nav-link">Editor</a></li>
          <li><a href="/chat.html" class="rams-nav-link">Chat</a></li>
        </ul>
      </div>

      <div class="rams-nav-section">
        <div class="rams-nav-label">Advanced</div>
        <ul class="rams-nav-items">
          <li><a href="/docs/agent-guide.html" class="rams-nav-link">Agent Guide</a></li>
        </ul>
      </div>
    </nav>

    <div class="rams-sidebar-footer">
      <div class="rams-version">v1.0.0</div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="rams-main">

    <!-- Top Bar -->
    <div class="rams-topbar">
      <div class="rams-breadcrumb">
        <span class="rams-breadcrumb-current">Dashboard</span>
      </div>
      <div class="rams-topbar-actions">
        <div
          id="status-indicator-top"
          hx-get="/api/partials/status-indicator"
          hx-trigger="load, every 5s, sse:run_started, sse:run_completed"
          hx-swap="innerHTML"
          hx-timeout="5000"
        ></div>
      </div>
    </div>

    <!-- Content Area -->
    <article class="rams-content">

      <!-- Critical Alerts Banner -->
      <section class="rams-section">
        <div
          id="critical-alerts-container"
          hx-get="/api/partials/critical-alerts"
          hx-trigger="load, every 60s, sse:run_completed, sse:budget_exceeded, sse:file_changed"
          hx-swap="innerHTML transition:true"
          hx-timeout="10000"
          class="sse-updatable"
        >
          <!-- Critical alerts appear when issues require attention -->
        </div>
      </section>

      <!-- Dashboard Overview Header -->
      <section class="rams-section">
        <div class="rams-section-header">
          <h1 class="rams-h1">Dashboard Overview</h1>
          <div class="rams-topbar-actions">
            <a href="/streams.html?new=true" class="rams-btn rams-btn-primary">
              + New Stream
            </a>
          </div>
        </div>
      </section>

      <!-- Aggregate Metrics Cards -->
      <section class="rams-section">
        <div class="dashboard-metrics-grid">
          <!-- Total Cost Card -->
          <div
            id="cost-summary-card"
            hx-get="/api/partials/cost-summary-card"
            hx-trigger="load, every 60s, sse:cost_updated, sse:run_completed"
            hx-swap="innerHTML transition:true swap:0.2s"
            hx-timeout="10000"
            class="sse-updatable"
            style="position: relative;"
          >
            <!-- Skeleton Loader -->
            <div class="rams-card skeleton-card skeleton-metric-card">
              <div class="skeleton skeleton-metric-label"></div>
              <div class="skeleton skeleton-metric-value"></div>
              <div class="skeleton skeleton-progress-bar"></div>
              <div class="skeleton skeleton-text" style="width: 80%;"></div>
              <div class="skeleton skeleton-text" style="width: 60%;"></div>
            </div>
          </div>

          <!-- Success Rate Card -->
          <div
            id="success-rate-card"
            hx-get="/api/partials/success-rate-card"
            hx-trigger="load, every 60s, sse:run_completed"
            hx-swap="innerHTML transition:true swap:0.2s"
            hx-timeout="10000"
            class="sse-updatable"
            style="position: relative;"
          >
            <!-- Skeleton Loader -->
            <div class="rams-card skeleton-card skeleton-metric-card">
              <div class="skeleton skeleton-metric-label"></div>
              <div class="skeleton skeleton-metric-value"></div>
              <div class="skeleton skeleton-text" style="width: 70%;"></div>
            </div>
          </div>

          <!-- Active Streams Card -->
          <div
            id="active-streams-card"
            hx-get="/api/partials/active-streams-card"
            hx-trigger="load, every 10s, sse:run_started, sse:run_completed, sse:stream_updated"
            hx-swap="innerHTML transition:true swap:0.2s"
            hx-timeout="10000"
            class="sse-updatable"
            style="position: relative;"
          >
            <!-- Skeleton Loader -->
            <div class="rams-card skeleton-card skeleton-metric-card">
              <div class="skeleton skeleton-metric-label"></div>
              <div class="skeleton skeleton-metric-value"></div>
              <div class="skeleton skeleton-text" style="width: 65%;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Active Streams Grid -->
      <section class="rams-section">
        <div class="rams-section-header">
          <h2 class="rams-h2">Active Streams</h2>
          <div style="display: flex; gap: var(--rams-space-2);">
            <button
              class="rams-btn rams-btn-secondary rams-btn-sm"
              onclick="filterStreamGrid('all')"
            >
              All
            </button>
            <button
              class="rams-btn rams-btn-secondary rams-btn-sm"
              onclick="filterStreamGrid('running')"
            >
              Running
            </button>
            <button
              class="rams-btn rams-btn-secondary rams-btn-sm"
              onclick="filterStreamGrid('ready')"
            >
              Ready
            </button>
            <button
              class="rams-btn rams-btn-secondary rams-btn-sm"
              onclick="filterStreamGrid('completed')"
            >
              Completed
            </button>
          </div>
        </div>

        <div
          id="streams-grid-container"
          hx-get="/api/partials/streams-grid"
          hx-trigger="load, every 10s, sse:run_started, sse:run_completed, sse:stream_updated"
          hx-swap="innerHTML transition:true swap:0.2s"
          hx-timeout="15000"
          class="sse-updatable"
          style="position: relative;"
        >
          <!-- Skeleton Loaders for Stream Cards -->
          <div class="dashboard-streams-grid">
            <div class="rams-card skeleton-card skeleton-stream-card">
              <div class="skeleton skeleton-title"></div>
              <div class="skeleton skeleton-progress-bar"></div>
              <div class="skeleton skeleton-text"></div>
              <div class="skeleton skeleton-text" style="width: 80%;"></div>
            </div>
            <div class="rams-card skeleton-card skeleton-stream-card">
              <div class="skeleton skeleton-title"></div>
              <div class="skeleton skeleton-progress-bar"></div>
              <div class="skeleton skeleton-text"></div>
              <div class="skeleton skeleton-text" style="width: 80%;"></div>
            </div>
            <div class="rams-card skeleton-card skeleton-stream-card">
              <div class="skeleton skeleton-title"></div>
              <div class="skeleton skeleton-progress-bar"></div>
              <div class="skeleton skeleton-text"></div>
              <div class="skeleton skeleton-text" style="width: 80%;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Trends Section -->
      <section class="rams-section">
        <div class="rams-section-header">
          <h2 class="rams-h2">Trends</h2>
          <a href="/trends.html" class="rams-btn rams-btn-secondary rams-btn-sm">
            View Full â†’
          </a>
        </div>

        <div class="dashboard-trends-grid">
          <!-- Cost Trend Chart -->
          <div class="rams-card">
            <div class="chart-controls">
              <div class="chart-title">Cost Trend</div>
              <div class="chart-period-selector">
                <button class="chart-period-btn active" data-chart="cost" data-period="7d">7d</button>
                <button class="chart-period-btn" data-chart="cost" data-period="30d">30d</button>
              </div>
            </div>
            <div class="chart-container" style="position: relative;">
              <canvas id="cost-chart" class="chart-canvas"></canvas>
              <!-- Skeleton loader shown until chart initializes -->
              <div class="chart-skeleton" id="cost-chart-skeleton">
                <div class="skeleton skeleton-chart"></div>
              </div>
            </div>
          </div>

          <!-- Velocity Trend Chart -->
          <div class="rams-card">
            <div class="chart-controls">
              <div class="chart-title">Velocity</div>
              <div class="chart-period-selector">
                <button class="chart-period-btn active" data-chart="velocity" data-period="7d">7d</button>
                <button class="chart-period-btn" data-chart="velocity" data-period="30d">30d</button>
              </div>
            </div>
            <div class="chart-container" style="position: relative;">
              <canvas id="velocity-chart" class="chart-canvas"></canvas>
              <!-- Skeleton loader shown until chart initializes -->
              <div class="chart-skeleton" id="velocity-chart-skeleton">
                <div class="skeleton skeleton-chart"></div>
              </div>
            </div>
          </div>

          <!-- Success Rate Trend Chart -->
          <div class="rams-card">
            <div class="chart-controls">
              <div class="chart-title">Success Rate</div>
              <div class="chart-period-selector">
                <button class="chart-period-btn active" data-chart="success" data-period="7d">7d</button>
                <button class="chart-period-btn" data-chart="success" data-period="30d">30d</button>
              </div>
            </div>
            <div class="chart-container" style="position: relative;">
              <canvas id="success-chart" class="chart-canvas"></canvas>
              <!-- Skeleton loader shown until chart initializes -->
              <div class="chart-skeleton" id="success-chart-skeleton">
                <div class="skeleton skeleton-chart"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

    </article>

  </main>

  <!-- Alert Toast for Errors -->
  <div id="error-toast" class="rams-alert rams-alert-error rams-hidden rams-toast">
    <div class="rams-toast-content">
      <div class="rams-toast-body">
        <div class="rams-toast-title">Error</div>
        <div id="error-toast-message" class="rams-text-sm"></div>
      </div>
      <button onclick="dismissErrorToast()" class="rams-toast-close">&times;</button>
    </div>
  </div>

  <!-- Connection Lost Banner -->
  <div id="connection-banner" class="rams-alert rams-alert-warning rams-hidden rams-banner">
    <div class="rams-banner-content">
      <span>Connection lost. Reconnecting...</span>
      <button onclick="window.location.reload()" class="rams-btn rams-btn-secondary rams-btn-sm">Reload Page</button>
    </div>
  </div>

  <script>
    // SSE Visual Feedback
    document.body.addEventListener("htmx:sseMessage", function (event) {
      var target = event.target;
      if (target && target.classList) {
        target.classList.add("sse-updated");
        setTimeout(function () {
          target.classList.remove("sse-updated");
        }, 1000);
      }
    });

    document.body.addEventListener("htmx:afterSwap", function (event) {
      var target = event.detail.target;
      if (target && target.classList && target.classList.contains("sse-updatable")) {
        target.classList.add("sse-updated");
        setTimeout(function () {
          target.classList.remove("sse-updated");
        }, 1000);
      }
    });

    // SSE Connection Status
    document.body.addEventListener("htmx:sseOpen", function (event) {
      console.log("[SSE] Connected to event stream");
      var banner = document.getElementById("connection-banner");
      if (banner) banner.classList.add("rams-hidden");
    });

    document.body.addEventListener("htmx:sseError", function (event) {
      console.warn("[SSE] Connection error, will retry...");
      var banner = document.getElementById("connection-banner");
      if (banner) banner.classList.remove("rams-hidden");
    });

    // Stream Grid Filtering
    function filterStreamGrid(filter) {
      var container = document.getElementById('streams-grid-container');
      if (!container) return;

      var url = '/api/partials/streams-grid';
      if (filter && filter !== 'all') {
        url += '?filter=' + filter;
      }

      container.setAttribute('hx-get', url);
      htmx.process(container);
      htmx.trigger(container, 'load');
    }


    // Error Toast Management
    var lastFailedRequest = null;

    function showErrorToast(message, endpoint) {
      console.error("[Error]", message, endpoint ? "(Endpoint: " + endpoint + ")" : "");
      var toast = document.getElementById("error-toast");
      var messageEl = document.getElementById("error-toast-message");

      messageEl.textContent = message;
      toast.classList.remove("rams-hidden");

      setTimeout(function() {
        dismissErrorToast();
      }, 10000);
    }

    function dismissErrorToast() {
      var toast = document.getElementById("error-toast");
      toast.classList.add("rams-hidden");
    }

    document.body.addEventListener("htmx:responseError", function (event) {
      var xhr = event.detail.xhr;
      var path = event.detail.pathInfo ? event.detail.pathInfo.requestPath : "unknown";

      var message = "Request failed";
      if (xhr && xhr.status) {
        if (xhr.status === 0) {
          message = "Unable to connect to server. Check if the server is running.";
        } else if (xhr.status === 404) {
          message = "Resource not found: " + path;
        } else if (xhr.status === 500) {
          message = "Server error occurred. Please try again.";
          try {
            var response = JSON.parse(xhr.responseText);
            if (response.message) {
              message = response.message;
            }
          } catch (e) {}
        } else {
          message = "Request failed with status " + xhr.status;
        }
      }

      lastFailedRequest = { element: event.target };
      showErrorToast(message, path);
    });

    document.body.addEventListener("htmx:sendError", function (event) {
      var path = event.detail.pathInfo ? event.detail.pathInfo.requestPath : "unknown";
      console.error("[HTMX Send Error] Failed to send request:", path, event.detail);
      lastFailedRequest = { element: event.target };
      showErrorToast("Network error: Unable to send request. Check your connection.", path);
    });

    document.body.addEventListener("htmx:timeout", function (event) {
      var path = event.detail.pathInfo ? event.detail.pathInfo.requestPath : "unknown";
      console.error("[HTMX Timeout] Request timed out:", path);
      lastFailedRequest = { element: event.target };
      showErrorToast("Request timed out. The server may be busy.", path);
    });

  </script>

  <!-- Dashboard Charts -->
  <script src="/js/dashboard-charts.js"></script>
</body>
</html>
