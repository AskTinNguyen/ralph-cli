<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/favicon.png">
  <title>Ralph CLI - Editor</title>
  <link rel="stylesheet" href="/css/rams-ui.css">
  <script src="/js/htmx.min.js"></script>
  <script src="/js/marked.min.js"></script>
  <!-- Prism.js for syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>
  <!-- Mermaid.js for diagram rendering -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <style>
    /* Editor-specific styles following Rams design system principles */
    .editor-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 240px);
    }
    .editor-pane, .preview-pane {
      display: flex;
      flex-direction: column;
      border: var(--rams-border-width) solid var(--rams-border-color);
      border-radius: var(--rams-radius-md);
      overflow: hidden;
      background: var(--rams-white);
      height: 100%;
    }
    .pane-hidden {
      display: none;
    }
    .pane-header {
      padding: var(--rams-space-3) var(--rams-space-4);
      background: var(--rams-gray-50);
      border-bottom: var(--rams-border-width) solid var(--rams-border-color);
      font-weight: 500;
      font-size: var(--rams-text-sm);
      color: var(--rams-gray-700);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .view-toggle {
      display: flex;
      gap: var(--rams-space-2);
      background: var(--rams-white);
      border: var(--rams-border-width) solid var(--rams-border-color);
      border-radius: var(--rams-radius-sm);
      padding: 2px;
    }
    .view-toggle-btn {
      padding: var(--rams-space-2) var(--rams-space-3);
      font-size: var(--rams-text-xs);
      font-weight: 500;
      background: transparent;
      border: none;
      border-radius: var(--rams-radius-sm);
      color: var(--rams-gray-600);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .view-toggle-btn:hover {
      color: var(--rams-gray-900);
      background: var(--rams-gray-100);
    }
    .view-toggle-btn.active {
      background: var(--rams-accent);
      color: white;
    }
    .pane-header-right {
      display: flex;
      align-items: center;
      gap: var(--rams-space-3);
    }
    .pane-actions {
      display: flex;
      gap: var(--rams-space-2);
    }
    .rams-btn-sm {
      padding: var(--rams-space-2) var(--rams-space-3);
      font-size: var(--rams-text-xs);
    }
    .editor-textarea {
      flex: 1;
      border: none;
      padding: var(--rams-space-4);
      font-family: var(--rams-font-mono);
      font-size: var(--rams-text-sm);
      line-height: 1.6;
      resize: none;
      outline: none;
      background: var(--rams-white);
      color: var(--rams-gray-900);
    }
    .editor-textarea:focus {
      outline: none;
    }
    .editor-textarea:disabled {
      background: var(--rams-gray-50);
      color: var(--rams-gray-500);
      cursor: not-allowed;
    }
    .syntax-view {
      flex: 1;
      overflow-y: auto;
      background: #2d2d2d;
      padding: 0;
    }
    .syntax-view pre {
      margin: 0;
      padding: var(--rams-space-4);
      background: transparent;
      border: none;
      border-radius: 0;
    }
    .syntax-view code {
      font-family: var(--rams-font-mono);
      font-size: var(--rams-text-sm);
      line-height: 1.6;
    }
    .preview-content {
      flex: 1;
      padding: var(--rams-space-4);
      overflow-y: auto;
      line-height: var(--rams-leading-relaxed);
      color: var(--rams-gray-700);
    }
    .preview-content h1 {
      font-size: var(--rams-text-2xl);
      font-weight: 600;
      letter-spacing: var(--rams-tracking-tight);
      color: var(--rams-gray-900);
      margin-top: var(--rams-space-6);
      margin-bottom: var(--rams-space-3);
    }
    .preview-content h2 {
      font-size: var(--rams-text-xl);
      font-weight: 600;
      letter-spacing: var(--rams-tracking-tight);
      color: var(--rams-gray-900);
      margin-top: var(--rams-space-6);
      margin-bottom: var(--rams-space-3);
    }
    .preview-content h3 {
      font-size: var(--rams-text-lg);
      font-weight: 600;
      letter-spacing: var(--rams-tracking-tight);
      color: var(--rams-gray-900);
      margin-top: var(--rams-space-6);
      margin-bottom: var(--rams-space-3);
    }
    .preview-content h1:first-child,
    .preview-content h2:first-child,
    .preview-content h3:first-child {
      margin-top: 0;
    }
    .preview-content p {
      margin-bottom: var(--rams-space-4);
    }
    .preview-content ul, .preview-content ol {
      margin-bottom: var(--rams-space-4);
      padding-left: var(--rams-space-6);
    }
    .preview-content li {
      margin-bottom: var(--rams-space-2);
    }
    .preview-content code {
      background: var(--rams-gray-100);
      padding: 2px 6px;
      border-radius: var(--rams-radius-sm);
      font-family: var(--rams-font-mono);
      font-size: 0.9em;
      color: var(--rams-gray-900);
    }
    .preview-content pre {
      background: var(--rams-gray-900);
      padding: var(--rams-space-4);
      border-radius: var(--rams-radius-md);
      overflow-x: auto;
      margin-bottom: var(--rams-space-4);
      border: var(--rams-border-width) solid var(--rams-gray-800);
    }
    .preview-content pre code {
      background: none;
      padding: 0;
      color: var(--rams-gray-200);
    }
    .preview-content blockquote {
      border-left: 3px solid var(--rams-accent);
      padding-left: var(--rams-space-4);
      margin: var(--rams-space-4) 0;
      color: var(--rams-gray-600);
      font-style: italic;
    }
    .preview-content table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: var(--rams-space-4);
    }
    .preview-content table th {
      text-align: left;
      padding: var(--rams-space-3) var(--rams-space-4);
      font-size: var(--rams-text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--rams-gray-500);
      background: var(--rams-gray-50);
      border-bottom: var(--rams-border-width) solid var(--rams-border-color);
    }
    .preview-content table td {
      padding: var(--rams-space-3) var(--rams-space-4);
      border-bottom: var(--rams-border-width) solid var(--rams-gray-200);
    }
    .empty-state {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--rams-gray-500);
      font-size: var(--rams-text-sm);
    }
    .mermaid-wrapper {
      margin: var(--rams-space-4) 0;
      padding: var(--rams-space-4);
      background: var(--rams-white);
      border: var(--rams-border-width) solid var(--rams-border-color);
      border-radius: var(--rams-radius-md);
      overflow-x: auto;
      display: flex;
      justify-content: center;
    }
    .mermaid-wrapper svg {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body class="rams-page">

  <!-- Persistent Sidebar -->
  <aside class="rams-sidebar">
    <div class="rams-sidebar-header">
      <div class="rams-logo">
        <div class="rams-logo-mark"></div>
        <span class="rams-logo-text">RALPH</span>
      </div>
    </div>

    <nav class="rams-nav">
      <div class="rams-nav-section">
        <div class="rams-nav-label">Main</div>
        <ul class="rams-nav-items">
          <li><a href="/" class="rams-nav-link">Home</a></li>
          <li><a href="/dashboard.html" class="rams-nav-link">Dashboard</a></li>
          <li><a href="/streams.html" class="rams-nav-link">Streams</a></li>
          <li><a href="/docs/" class="rams-nav-link">Documentation</a></li>
        </ul>
      </div>

      <div class="rams-nav-section">
        <div class="rams-nav-label">Monitoring</div>
        <ul class="rams-nav-items">
          <li><a href="/logs.html" class="rams-nav-link">Logs</a></li>
          <li><a href="/tokens.html" class="rams-nav-link">Tokens</a></li>
          <li><a href="/trends.html" class="rams-nav-link">Trends</a></li>
        </ul>
      </div>

      <div class="rams-nav-section">
        <div class="rams-nav-label">Tools</div>
        <ul class="rams-nav-items">
          <li><a href="/editor.html" class="rams-nav-link active">Editor</a></li>
          <li><a href="/chat.html" class="rams-nav-link">Chat</a></li>
        </ul>
      </div>

      <div class="rams-nav-section">
        <div class="rams-nav-label">Advanced</div>
        <ul class="rams-nav-items">
          <li><a href="/docs/agent-guide.html" class="rams-nav-link">Agent Guide</a></li>
        </ul>
      </div>
    </nav>

    <div class="rams-sidebar-footer">
      <div class="rams-version">v1.0.0</div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="rams-main">

    <!-- Top Bar -->
    <div class="rams-topbar">
      <div class="rams-breadcrumb">
        <span class="rams-breadcrumb-current">Editor</span>
      </div>
      <div class="rams-topbar-actions">
        <select id="stream-selector" class="rams-select" style="width: auto; min-width: 150px;">
          <option value="">Select a stream...</option>
        </select>
        <select id="file-selector" class="rams-select" style="width: auto; min-width: 150px;" disabled>
          <option value="">Select a file...</option>
        </select>
        <button id="open-in-editor-btn" class="rams-btn rams-btn-secondary" disabled>
          Open in Editor
        </button>
      </div>
    </div>

    <!-- Content Area -->
    <article class="rams-content">

      <section class="rams-section">
        <div class="editor-container">
          <!-- Edit Pane -->
          <div id="edit-pane" class="editor-pane">
            <div class="pane-header">
              <span class="pane-title">Edit</span>
              <div class="pane-header-right">
                <div class="view-toggle">
                  <button class="view-toggle-btn active" onclick="switchView('edit')">Edit</button>
                  <button class="view-toggle-btn" onclick="switchView('preview')">Preview</button>
                </div>
                <div class="pane-actions">
                  <button id="copy-btn" class="rams-btn rams-btn-secondary rams-btn-sm" onclick="copyContent()">Copy</button>
                  <button id="save-btn" class="rams-btn rams-btn-primary rams-btn-sm" onclick="saveFile()" disabled>Save</button>
                </div>
              </div>
            </div>
            <textarea id="editor-textarea" class="editor-textarea" placeholder="Select a stream and file to edit..."></textarea>
          </div>

          <!-- Preview Pane -->
          <div id="preview-pane" class="preview-pane pane-hidden">
            <div class="pane-header">
              <span class="pane-title">Preview</span>
              <div class="view-toggle">
                <button class="view-toggle-btn" onclick="switchView('edit')">Edit</button>
                <button class="view-toggle-btn active" onclick="switchView('preview')">Preview</button>
              </div>
            </div>
            <div id="preview-content" class="preview-content">
              <div class="empty-state">
                <p>Markdown preview will appear here</p>
              </div>
            </div>
          </div>
        </div>
      </section>

    </article>

  </main>

  <script>
    let currentStreamId = "";
    let currentFile = "";
    let currentFilePath = "";
    let currentView = "edit"; // edit or preview
    let originalContent = "";

    if (typeof marked !== "undefined") {
      marked.setOptions({
        breaks: true,
        gfm: true,
      });
    }

    // Initialize Mermaid
    if (typeof mermaid !== "undefined") {
      mermaid.initialize({
        startOnLoad: false,
        theme: 'default',
        securityLevel: 'loose'
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadStreams();
      setInterval(() => loadStreams(true), 10000);

      // Track changes in textarea
      document.getElementById("editor-textarea").addEventListener("input", updateSaveButton);

      // Check for URL parameters to auto-load a PRD
      const urlParams = new URLSearchParams(window.location.search);
      const prdParam = urlParams.get('prd');
      const fileParam = urlParams.get('file') || 'prd';

      if (prdParam) {
        // Wait for streams to load, then auto-select
        setTimeout(async () => {
          await loadPrdFromUrl(prdParam, fileParam);
        }, 500);
      }
    });

    async function loadPrdFromUrl(prdId, fileType) {
      try {
        // Set the stream selector
        const streamSelector = document.getElementById("stream-selector");
        streamSelector.value = prdId;
        currentStreamId = prdId;

        // Trigger stream change to load files
        const event = new Event('change');
        streamSelector.dispatchEvent(event);

        // Wait for files to load, then select the file
        setTimeout(() => {
          const fileSelector = document.getElementById("file-selector");
          const fileValue = fileType.endsWith('.md') ? fileType : `${fileType}.md`;
          fileSelector.value = fileValue;
          currentFile = fileValue;

          // Trigger file change to load content
          const fileEvent = new Event('change');
          fileSelector.dispatchEvent(fileEvent);
        }, 300);

        // Update breadcrumb to show we're editing a specific PRD
        const breadcrumb = document.querySelector('.rams-breadcrumb');
        if (breadcrumb) {
          breadcrumb.innerHTML = `
            <a href="/editor.html" style="color: var(--rams-gray-600); text-decoration: none;">Editor</a>
            <span style="color: var(--rams-gray-400); margin: 0 var(--rams-space-2);">/</span>
            <span class="rams-breadcrumb-current">PRD-${prdId}</span>
          `;
        }
      } catch (error) {
        console.error("Failed to load PRD from URL:", error);
      }
    }

    // Switch between edit and preview
    function switchView(view) {
      currentView = view;
      const editPane = document.getElementById("edit-pane");
      const previewPane = document.getElementById("preview-pane");

      if (view === "edit") {
        editPane.classList.remove("pane-hidden");
        previewPane.classList.add("pane-hidden");
      } else {
        editPane.classList.add("pane-hidden");
        previewPane.classList.remove("pane-hidden");
        // Update preview with current editor content
        const textarea = document.getElementById("editor-textarea");
        updatePreview(textarea.value);
      }

      // Update toggle button states in both panes
      document.querySelectorAll(".view-toggle-btn").forEach(btn => {
        const btnView = btn.textContent.toLowerCase();
        btn.classList.toggle("active", btnView === view);
      });
    }

    // Copy content to clipboard
    async function copyContent() {
      const textarea = document.getElementById("editor-textarea");
      const copyBtn = document.getElementById("copy-btn");

      try {
        await navigator.clipboard.writeText(textarea.value);
        copyBtn.textContent = "Copied!";
        setTimeout(() => copyBtn.textContent = "Copy", 1500);
      } catch (err) {
        console.error("Copy failed:", err);
        copyBtn.textContent = "Failed";
        setTimeout(() => copyBtn.textContent = "Copy", 1500);
      }
    }

    // Save file to server
    async function saveFile() {
      const textarea = document.getElementById("editor-textarea");
      const saveBtn = document.getElementById("save-btn");

      if (!currentFilePath) return;

      saveBtn.disabled = true;
      saveBtn.textContent = "Saving...";

      try {
        const response = await fetch(`/api/files/${encodeURIComponent(currentFilePath)}`, {
          method: "PUT",
          headers: { "Content-Type": "text/plain" },
          body: textarea.value
        });

        if (!response.ok) throw new Error("Failed to save");

        originalContent = textarea.value;
        saveBtn.textContent = "Saved!";

        setTimeout(() => {
          saveBtn.textContent = "Save";
          updateSaveButton();
        }, 1500);
      } catch (error) {
        console.error("Save failed:", error);
        saveBtn.textContent = "Failed";
        setTimeout(() => {
          saveBtn.textContent = "Save";
          saveBtn.disabled = false;
        }, 2000);
      }
    }

    // Enable/disable save button based on changes
    function updateSaveButton() {
      const textarea = document.getElementById("editor-textarea");
      const saveBtn = document.getElementById("save-btn");
      const hasChanges = textarea.value !== originalContent;
      saveBtn.disabled = !hasChanges || !currentFilePath;
    }

    async function loadStreams(preserveSelection = false) {
      try {
        const response = await fetch("/api/streams");
        const data = await response.json();

        const selector = document.getElementById("stream-selector");
        const currentSelection = preserveSelection ? selector.value : "";

        if (!data.streams) {
          console.warn("No streams data received");
          return;
        }

        selector.innerHTML = '<option value="">Select a stream...</option>';

        if (data.streams.length > 0) {
          data.streams.forEach((stream) => {
            const option = document.createElement("option");
            option.value = stream.id;
            option.textContent = `PRD-${stream.id}: ${stream.name}`;
            selector.appendChild(option);
          });

          if (currentSelection && data.streams.some((s) => s.id === currentSelection)) {
            selector.value = currentSelection;
          }
        }
      } catch (error) {
        console.error("Failed to load streams:", error);
      }
    }

    document.getElementById("stream-selector").addEventListener("change", async (e) => {
      currentStreamId = e.target.value;
      currentFile = "";
      currentFilePath = "";
      originalContent = "";
      const fileSelector = document.getElementById("file-selector");
      const textarea = document.getElementById("editor-textarea");
      const preview = document.getElementById("preview-content");
      const openBtn = document.getElementById("open-in-editor-btn");

      if (!currentStreamId) {
        fileSelector.innerHTML = '<option value="">Select a file...</option>';
        fileSelector.disabled = true;
        textarea.value = "";
        textarea.placeholder = "Select a stream and file to edit...";
        preview.innerHTML = '<div class="empty-state"><p>Markdown preview will appear here</p></div>';
        openBtn.disabled = true;
        updateSaveButton();
        return;
      }

      try {
        const response = await fetch(`/api/streams/${currentStreamId}`);
        const data = await response.json();

        fileSelector.innerHTML = '<option value="">Select a file...</option>';

        const files = [];
        if (data.hasPrd) files.push({ value: "prd.md", label: "prd.md (Product Requirements)" });
        if (data.hasPlan) files.push({ value: "plan.md", label: "plan.md (Implementation Plan)" });
        if (data.hasProgress) files.push({ value: "progress.md", label: "progress.md (Progress Log)" });

        files.forEach((file) => {
          const option = document.createElement("option");
          option.value = file.value;
          option.textContent = file.label;
          fileSelector.appendChild(option);
        });

        fileSelector.disabled = files.length === 0;

        if (files.length === 0) {
          fileSelector.innerHTML = '<option value="">No files available</option>';
        } else if (files.length > 0) {
          fileSelector.value = files[0].value;
          fileSelector.dispatchEvent(new Event("change"));
        }
      } catch (error) {
        console.error("Failed to load stream details:", error);
        fileSelector.innerHTML = '<option value="">Error loading files</option>';
        fileSelector.disabled = true;
      }
    });

    document.getElementById("file-selector").addEventListener("change", async (e) => {
      currentFile = e.target.value;
      const textarea = document.getElementById("editor-textarea");
      const preview = document.getElementById("preview-content");
      const openBtn = document.getElementById("open-in-editor-btn");

      if (!currentFile || !currentStreamId) {
        textarea.value = "";
        textarea.placeholder = "Select a stream and file to edit...";
        preview.innerHTML = '<div class="empty-state"><p>Markdown preview will appear here</p></div>';
        openBtn.disabled = true;
        currentFilePath = "";
        originalContent = "";
        updateSaveButton();
        return;
      }

      try {
        const filePath = `PRD-${currentStreamId}/${currentFile}`;
        currentFilePath = filePath;
        const response = await fetch(`/api/files/${encodeURIComponent(filePath)}`);

        if (!response.ok) {
          throw new Error(`Failed to load file: ${response.status}`);
        }

        const content = await response.text();

        // Load into textarea
        textarea.value = content;
        originalContent = content;

        // Update preview
        updatePreview(content);

        openBtn.disabled = false;
        updateSaveButton();
      } catch (error) {
        console.error("Failed to load file:", error);
        textarea.value = "";
        textarea.placeholder = "Error loading file";
        preview.innerHTML = '<div class="empty-state"><p>Error loading file</p></div>';
        openBtn.disabled = true;
        currentFilePath = "";
        originalContent = "";
        updateSaveButton();
      }
    });

    async function openInExternalEditor() {
      if (!currentFilePath) {
        return;
      }

      const openBtn = document.getElementById("open-in-editor-btn");
      openBtn.disabled = true;
      openBtn.textContent = "Opening...";

      try {
        const response = await fetch(`/api/files/${encodeURIComponent(currentFilePath)}/open`, {
          method: "POST",
        });

        if (!response.ok) {
          throw new Error("Failed to open file");
        }

        setTimeout(() => {
          openBtn.textContent = "Open in Editor";
          openBtn.disabled = false;
        }, 1000);
      } catch (error) {
        console.error("Failed to open file:", error);
        openBtn.textContent = "Open in Editor";
        openBtn.disabled = false;
      }
    }

    document.getElementById("open-in-editor-btn").addEventListener("click", openInExternalEditor);

    async function updatePreview(content) {
      const preview = document.getElementById("preview-content");

      if (!content || content.trim() === "") {
        preview.innerHTML = '<div class="empty-state"><p>Markdown preview will appear here</p></div>';
        return;
      }

      try {
        let html = "";
        if (typeof marked !== "undefined" && typeof marked.parse === "function") {
          html = marked.parse(content);
        } else {
          html = "<pre>" + escapeHtml(content) + "</pre>";
        }

        preview.innerHTML = html;

        // Render Mermaid diagrams
        if (typeof mermaid !== "undefined") {
          const mermaidBlocks = preview.querySelectorAll('code.language-mermaid');
          for (let i = 0; i < mermaidBlocks.length; i++) {
            const block = mermaidBlocks[i];
            const code = block.textContent;
            try {
              const { svg } = await mermaid.render(`mermaid-${Date.now()}-${i}`, code);
              const wrapper = document.createElement('div');
              wrapper.className = 'mermaid-wrapper';
              wrapper.innerHTML = svg;
              block.parentElement.replaceWith(wrapper);
            } catch (err) {
              console.error("Mermaid rendering error:", err);
              block.parentElement.innerHTML = `<pre style="color: red;">Mermaid Error: ${err.message}</pre>`;
            }
          }
        }
      } catch (error) {
        console.error("Markdown parsing error:", error);
        preview.innerHTML = "<pre>" + escapeHtml(content) + "</pre>";
      }
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
