<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ralph CLI - Dashboard</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <script src="/js/htmx.min.js"></script>
    <script src="/js/htmx-ext-sse.js"></script>
  </head>
  <body hx-ext="sse" sse-connect="/api/events">
    <!-- Connection Lost Banner -->
    <div id="connection-banner" class="connection-lost hidden">
      <span>Connection lost. Reconnecting...</span>
      <button onclick="window.location.reload()">Reload Page</button>
    </div>

    <!-- Error Toast Container -->
    <div id="error-toast" class="error-toast hidden">
      <div class="error-toast-header">
        <span class="error-toast-title">Error</span>
        <button class="error-toast-dismiss" onclick="dismissErrorToast()">&times;</button>
      </div>
      <div class="error-toast-message" id="error-toast-message"></div>
      <div class="error-toast-actions">
        <button class="retry-button" id="error-toast-retry" onclick="retryLastRequest()">
          <span class="retry-icon">&#8635;</span> Retry
        </button>
      </div>
    </div>

    <header>
      <div class="header-content">
        <h1>Ralph CLI</h1>
        <span class="subtitle">Autonomous Coding Loop</span>
      </div>
      <nav>
        <a href="/" class="active">Dashboard</a>
        <a href="/streams.html">Streams</a>
        <a href="/logs.html">Logs</a>
        <a href="/tokens.html">Tokens</a>
        <a href="/editor.html">Editor</a>
      </nav>
    </header>

    <main>
      <!-- Command Center Section -->
      <section id="command-center-section">
        <h2>Command Center</h2>
        <div class="command-center">
          <div class="command-center-form">
            <div class="command-center-controls">
              <div class="control-group">
                <label for="iterations">Iterations</label>
                <input
                  type="number"
                  id="iterations"
                  name="iterations"
                  value="5"
                  min="1"
                  max="100"
                  class="control-input"
                />
              </div>
              <div class="control-group">
                <label for="agent">Agent</label>
                <select id="agent" name="agent" class="control-input">
                  <option value="claude" selected>Claude</option>
                  <option value="codex">Codex</option>
                  <option value="droid">Droid</option>
                </select>
              </div>
              <div class="control-group">
                <label for="stream">Stream</label>
                <select
                  id="stream"
                  name="stream"
                  class="control-input"
                  hx-get="/api/partials/stream-options"
                  hx-trigger="load"
                  hx-swap="innerHTML"
                >
                  <option value="">Default (latest)</option>
                </select>
              </div>
              <div class="control-group control-checkbox">
                <input type="checkbox" id="no-commit" name="noCommit" />
                <label for="no-commit">Dry run (no commit)</label>
              </div>
            </div>
            <div class="command-center-actions">
              <button
                type="button"
                id="start-build-btn"
                class="btn btn-primary"
                hx-post="/api/build/start"
                hx-vals="js:{iterations: parseInt(document.getElementById('iterations').value), agent: document.getElementById('agent').value, stream: document.getElementById('stream').value || undefined, noCommit: document.getElementById('no-commit').checked}"
                hx-target="#build-status-container"
                hx-swap="innerHTML"
                hx-indicator="#build-indicator"
              >
                <span class="btn-text">Start Build</span>
                <span class="htmx-indicator" id="build-indicator">...</span>
              </button>
              <button
                type="button"
                id="stop-build-btn"
                class="btn btn-danger"
                disabled
                hx-post="/api/build/stop"
                hx-target="#build-status-container"
                hx-swap="innerHTML"
              >
                Stop Build
              </button>
            </div>
          </div>
          <div class="command-center-status">
            <div class="build-status-label">Build Status</div>
            <div
              id="build-status-container"
              hx-get="/api/partials/build-status"
              hx-trigger="load, every 3s, sse:run_started, sse:run_completed"
              hx-swap="innerHTML"
            >
              <div class="build-status idle">
                <span class="build-status-dot"></span>
                <span class="build-status-text">Idle</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Progress Section -->
      <section id="progress-section">
        <h2>
          Overall Progress
          <span class="htmx-indicator" id="progress-indicator"
            ><span class="loading-spinner"></span
          ></span>
        </h2>
        <div
          id="progress-container"
          hx-get="/api/partials/progress"
          hx-trigger="load, every 5s, sse:progress_updated, sse:file_changed, sse:run_completed"
          hx-swap="innerHTML transition:true"
          hx-indicator="#progress-indicator"
          class="sse-updatable"
        >
          <div class="loading"><span class="loading-spinner"></span> Loading progress...</div>
        </div>
      </section>

      <!-- Stories Section -->
      <section id="stories-section">
        <h2>
          User Stories
          <span class="htmx-indicator" id="stories-indicator"
            ><span class="loading-spinner"></span
          ></span>
        </h2>
        <div
          id="stories-container"
          hx-get="/api/partials/stories"
          hx-trigger="load, every 5s, sse:progress_updated, sse:file_changed, sse:story_updated"
          hx-swap="innerHTML transition:true"
          hx-indicator="#stories-indicator"
          class="sse-updatable"
        >
          <div class="loading"><span class="loading-spinner"></span> Loading stories...</div>
        </div>
      </section>

      <!-- Accuracy Metrics Section -->
      <section id="accuracy-section">
        <div
          id="accuracy-container"
          hx-get="/api/partials/accuracy-widget"
          hx-trigger="load, every 60s, sse:run_completed"
          hx-swap="innerHTML transition:true"
        >
          <div class="loading"><span class="loading-spinner"></span> Loading accuracy metrics...</div>
        </div>
      </section>
    </main>

    <footer>
      <p>
        Ralph CLI Web UI &mdash;
        <span
          id="status-indicator"
          hx-get="/api/partials/status-indicator"
          hx-trigger="load, every 5s, sse:run_started, sse:run_completed"
          hx-swap="innerHTML"
          >checking...</span
        >
      </p>
    </footer>

    <script>
      // Add visual feedback when SSE updates are received
      document.body.addEventListener("htmx:sseMessage", function (event) {
        // Find the element that was updated
        var target = event.target;
        if (target && target.classList) {
          target.classList.add("sse-updated");
          // Remove the class after the animation completes
          setTimeout(function () {
            target.classList.remove("sse-updated");
          }, 1000);
        }
      });

      // Add visual feedback when content is swapped due to SSE
      document.body.addEventListener("htmx:afterSwap", function (event) {
        var target = event.detail.target;
        // Check if this swap was triggered by an SSE event
        if (target && target.classList && target.classList.contains("sse-updatable")) {
          target.classList.add("sse-updated");
          setTimeout(function () {
            target.classList.remove("sse-updated");
          }, 1000);
        }
      });

      // Log SSE connection status
      document.body.addEventListener("htmx:sseOpen", function (event) {
        console.log("[SSE] Connected to event stream");
      });

      document.body.addEventListener("htmx:sseError", function (event) {
        console.warn("[SSE] Connection error, will retry...");
      });

      // Command Center: Update button states based on build status
      function updateBuildButtons(isRunning) {
        var startBtn = document.getElementById("start-build-btn");
        var stopBtn = document.getElementById("stop-build-btn");
        var inputs = document.querySelectorAll(
          '#command-center-section .control-input, #command-center-section input[type="checkbox"]'
        );

        if (isRunning) {
          startBtn.disabled = true;
          startBtn.classList.add("disabled");
          stopBtn.disabled = false;
          stopBtn.classList.remove("disabled");
          inputs.forEach(function (input) {
            input.disabled = true;
          });
        } else {
          startBtn.disabled = false;
          startBtn.classList.remove("disabled");
          stopBtn.disabled = true;
          stopBtn.classList.add("disabled");
          inputs.forEach(function (input) {
            input.disabled = false;
          });
        }
      }

      // Watch for build status changes via HTMX afterSwap
      document.body.addEventListener("htmx:afterSwap", function (event) {
        if (event.detail.target && event.detail.target.id === "build-status-container") {
          var statusEl = event.detail.target.querySelector(".build-status");
          if (statusEl) {
            var isRunning = statusEl.classList.contains("running");
            updateBuildButtons(isRunning);
          }
        }
      });

      // Handle build start/stop responses
      document.body.addEventListener("htmx:afterRequest", function (event) {
        var target = event.detail.target;
        if (target && target.id === "build-status-container") {
          // Re-trigger status check to update button state
          htmx.trigger(target, "refresh");
        }
      });

      // ============================================
      // Error Handling
      // ============================================

      var lastFailedRequest = null;
      var sseReconnectAttempts = 0;

      // Show error toast
      function showErrorToast(message, endpoint) {
        console.error("[Error]", message, endpoint ? "(Endpoint: " + endpoint + ")" : "");
        var toast = document.getElementById("error-toast");
        var messageEl = document.getElementById("error-toast-message");
        var retryBtn = document.getElementById("error-toast-retry");

        messageEl.textContent = message;

        // Show/hide retry button based on whether we have a failed request
        if (lastFailedRequest) {
          retryBtn.style.display = "inline-flex";
        } else {
          retryBtn.style.display = "none";
        }

        toast.classList.remove("hidden", "dismissing");
      }

      // Dismiss error toast
      function dismissErrorToast() {
        var toast = document.getElementById("error-toast");
        toast.classList.add("dismissing");
        setTimeout(function () {
          toast.classList.add("hidden");
          toast.classList.remove("dismissing");
        }, 300);
      }

      // Retry last failed request
      function retryLastRequest() {
        if (lastFailedRequest) {
          var retryBtn = document.getElementById("error-toast-retry");
          retryBtn.classList.add("loading");
          retryBtn.disabled = true;

          var element = lastFailedRequest.element;
          var verb = lastFailedRequest.verb;

          // Re-trigger the request
          htmx.trigger(element, verb === "get" ? "load" : "click");

          // Reset button after a delay
          setTimeout(function () {
            retryBtn.classList.remove("loading");
            retryBtn.disabled = false;
            lastFailedRequest = null;
            dismissErrorToast();
          }, 1000);
        }
      }

      // HTMX error handlers
      document.body.addEventListener("htmx:responseError", function (event) {
        var xhr = event.detail.xhr;
        var target = event.detail.target;
        var path = event.detail.pathInfo ? event.detail.pathInfo.requestPath : "unknown";

        var message = "Request failed";
        if (xhr && xhr.status) {
          if (xhr.status === 0) {
            message = "Unable to connect to server. Check if the server is running.";
          } else if (xhr.status === 404) {
            message = "Resource not found: " + path;
          } else if (xhr.status === 500) {
            message = "Server error occurred. Please try again.";
            try {
              var response = JSON.parse(xhr.responseText);
              if (response.message) {
                message = response.message;
              }
            } catch (e) {}
          } else {
            message = "Request failed with status " + xhr.status;
          }
        }

        lastFailedRequest = {
          element: event.target,
          verb: event.detail.verb || "get",
        };

        showErrorToast(message, path);
      });

      document.body.addEventListener("htmx:sendError", function (event) {
        var path = event.detail.pathInfo ? event.detail.pathInfo.requestPath : "unknown";
        console.error("[HTMX Send Error] Failed to send request:", path, event.detail);

        lastFailedRequest = {
          element: event.target,
          verb: event.detail.verb || "get",
        };

        showErrorToast("Network error: Unable to send request. Check your connection.", path);
      });

      document.body.addEventListener("htmx:timeout", function (event) {
        var path = event.detail.pathInfo ? event.detail.pathInfo.requestPath : "unknown";
        console.error("[HTMX Timeout] Request timed out:", path);

        lastFailedRequest = {
          element: event.target,
          verb: event.detail.verb || "get",
        };

        showErrorToast("Request timed out. The server may be busy.", path);
      });

      // Enhanced SSE connection error handling
      document.body.addEventListener("htmx:sseError", function (event) {
        sseReconnectAttempts++;
        console.warn(
          "[SSE] Connection error (attempt " + sseReconnectAttempts + "), will retry..."
        );

        if (sseReconnectAttempts >= 3) {
          var banner = document.getElementById("connection-banner");
          banner.classList.remove("hidden");
        }
      });

      document.body.addEventListener("htmx:sseOpen", function (event) {
        console.log("[SSE] Connected to event stream");
        sseReconnectAttempts = 0;
        var banner = document.getElementById("connection-banner");
        banner.classList.add("hidden");
      });

      // Auto-dismiss error toast after 10 seconds
      setInterval(function () {
        var toast = document.getElementById("error-toast");
        if (!toast.classList.contains("hidden")) {
          // Only auto-dismiss if no retry is pending
          if (!lastFailedRequest) {
            dismissErrorToast();
          }
        }
      }, 10000);

      // ============================================
      // Stream Selector Integration
      // ============================================

      // Update progress and stories sections when stream selection changes
      document.getElementById("stream").addEventListener("change", function (e) {
        var streamId = e.target.value;
        var progressContainer = document.getElementById("progress-container");
        var storiesContainer = document.getElementById("stories-container");

        // Build new URLs with streamId parameter
        var progressUrl = "/api/partials/progress" + (streamId ? "?streamId=" + streamId : "");
        var storiesUrl = "/api/partials/stories" + (streamId ? "?streamId=" + streamId : "");

        // Update HTMX attributes
        progressContainer.setAttribute("hx-get", progressUrl);
        storiesContainer.setAttribute("hx-get", storiesUrl);

        // Reprocess HTMX to pick up new attributes
        htmx.process(progressContainer);
        htmx.process(storiesContainer);

        // Trigger immediate refresh
        htmx.trigger(progressContainer, "load");
        htmx.trigger(storiesContainer, "load");
      });
    </script>
  </body>
</html>
