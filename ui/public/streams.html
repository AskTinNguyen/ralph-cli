<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/favicon.png">
  <title>Ralph CLI - Streams</title>
  <link rel="stylesheet" href="/css/rams-ui.css">
  <script src="/js/htmx.min.js"></script>
  <style>
    /* Tab Navigation */
    .rams-tabs {
      display: flex;
      gap: var(--rams-space-1);
      border-bottom: 1px solid var(--rams-gray-200);
      margin-bottom: var(--rams-space-6);
    }

    .rams-tab {
      padding: var(--rams-space-3) var(--rams-space-5);
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--rams-gray-600);
      font-size: var(--rams-text-base);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--rams-transition-fast);
    }

    .rams-tab:hover {
      color: var(--rams-gray-900);
      background: var(--rams-gray-50);
    }

    .rams-tab.active {
      color: var(--rams-accent);
      border-bottom-color: var(--rams-accent);
      font-weight: 600;
    }

    .rams-tab-content {
      display: none;
    }

    .rams-tab-content.active {
      display: block;
    }

    /* Documentation tab specific overrides */
    #documentation-tab .rams-step {
      margin-bottom: var(--rams-space-6);
    }

    #documentation-tab .rams-section {
      margin-bottom: var(--rams-space-6);
    }

    #documentation-tab ul {
      list-style: disc;
      padding-left: var(--rams-space-6);
      margin: var(--rams-space-3) 0;
    }

    #documentation-tab ul li {
      color: var(--rams-gray-700);
      line-height: var(--rams-leading-relaxed);
      margin-bottom: var(--rams-space-2);
    }

    #documentation-tab ul li strong {
      color: var(--rams-gray-900);
      font-weight: 600;
    }

    /* Wizard Modal Styles */
    .wizard-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: wizardFadeIn 0.2s ease-out;
    }

    /* Ensure wizard is fully hidden when rams-hidden class is applied */
    .wizard-overlay.rams-hidden {
      display: none !important;
      pointer-events: none;
    }

    @keyframes wizardFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .wizard-container {
      background: var(--rams-white);
      border-radius: var(--rams-radius-xl);
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      animation: wizardSlideUp 0.3s ease-out;
    }

    @keyframes wizardSlideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .wizard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--rams-space-5) var(--rams-space-6);
      border-bottom: 1px solid var(--rams-gray-200);
    }

    .wizard-header h2 {
      margin: 0;
      font-size: var(--rams-text-xl);
      font-weight: 600;
      color: var(--rams-gray-900);
    }

    .wizard-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--rams-gray-500);
      cursor: pointer;
      padding: var(--rams-space-2);
      line-height: 1;
      border-radius: var(--rams-radius-md);
      transition: all var(--rams-transition-fast);
    }

    .wizard-close:hover {
      background: var(--rams-gray-100);
      color: var(--rams-gray-900);
    }

    .wizard-progress {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: var(--rams-space-5) var(--rams-space-6);
      gap: var(--rams-space-2);
      background: var(--rams-gray-50);
      border-bottom: 1px solid var(--rams-gray-200);
    }

    .wizard-step {
      display: flex;
      align-items: center;
      gap: var(--rams-space-2);
    }

    .wizard-step-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      background: var(--rams-gray-200);
      color: var(--rams-gray-600);
      transition: all var(--rams-transition-fast);
    }

    .wizard-step.active .wizard-step-circle {
      background: var(--rams-accent);
      color: var(--rams-white);
    }

    .wizard-step.completed .wizard-step-circle {
      background: var(--rams-accent);
      color: var(--rams-white);
    }

    .wizard-step.completed .wizard-step-circle::after {
      content: "‚úì";
    }

    .wizard-step.completed .wizard-step-number {
      display: none;
    }

    .wizard-step-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--rams-gray-500);
      display: none;
    }

    .wizard-step.active .wizard-step-label {
      color: var(--rams-gray-900);
      display: block;
    }

    .wizard-step-connector {
      width: 40px;
      height: 2px;
      background: var(--rams-gray-200);
    }

    .wizard-step.completed + .wizard-step-connector {
      background: var(--rams-accent);
    }

    .wizard-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--rams-space-6);
      min-height: 300px;
    }

    .wizard-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--rams-space-4) var(--rams-space-6);
      border-top: 1px solid var(--rams-gray-200);
      background: var(--rams-gray-50);
      border-radius: 0 0 var(--rams-radius-xl) var(--rams-radius-xl);
    }

    .wizard-footer-left,
    .wizard-footer-right {
      display: flex;
      gap: var(--rams-space-3);
    }

    /* Wizard Step Content Styles */
    .wizard-step-content h3 {
      font-size: var(--rams-text-lg);
      font-weight: 600;
      margin-bottom: var(--rams-space-2);
      color: var(--rams-gray-900);
    }

    .wizard-step-content p {
      color: var(--rams-gray-600);
      margin-bottom: var(--rams-space-5);
    }

    .wizard-textarea {
      width: 100%;
      min-height: 200px;
      padding: var(--rams-space-4);
      border: 2px solid var(--rams-gray-200);
      border-radius: var(--rams-radius-lg);
      font-size: var(--rams-text-base);
      font-family: inherit;
      resize: vertical;
      transition: border-color var(--rams-transition-fast);
    }

    .wizard-textarea:focus {
      outline: none;
      border-color: var(--rams-accent);
    }

    .wizard-textarea::placeholder {
      color: var(--rams-gray-400);
    }

    .wizard-char-count {
      text-align: right;
      font-size: 12px;
      color: var(--rams-gray-500);
      margin-top: var(--rams-space-2);
    }

    /* Generation Progress Styles */
    .wizard-generating {
      text-align: center;
      padding: var(--rams-space-8) var(--rams-space-4);
    }

    .wizard-generating h3 {
      margin-bottom: var(--rams-space-6);
    }

    .wizard-progress-bar {
      width: 100%;
      height: 8px;
      background: var(--rams-gray-200);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: var(--rams-space-6);
    }

    .wizard-progress-fill {
      height: 100%;
      background: var(--rams-accent);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .wizard-phases {
      text-align: left;
      max-width: 300px;
      margin: 0 auto var(--rams-space-6);
    }

    .wizard-phase {
      display: flex;
      align-items: center;
      gap: var(--rams-space-3);
      padding: var(--rams-space-2) 0;
      color: var(--rams-gray-500);
    }

    .wizard-phase.completed {
      color: var(--rams-accent);
    }

    .wizard-phase.active {
      color: var(--rams-gray-900);
      font-weight: 500;
    }

    .wizard-phase-icon {
      width: 20px;
      text-align: center;
    }

    .wizard-output-window {
      background: var(--rams-gray-900);
      color: var(--rams-gray-300);
      border-radius: var(--rams-radius-md);
      padding: var(--rams-space-3);
      font-family: 'SF Mono', monospace;
      font-size: 12px;
      max-height: 120px;
      overflow-y: auto;
      text-align: left;
      margin-top: var(--rams-space-4);
    }

    .wizard-output-line {
      padding: var(--rams-space-1) 0;
      opacity: 0.8;
    }

    .wizard-output-line:last-child {
      opacity: 1;
    }

    .wizard-time-estimate {
      font-size: 13px;
      color: var(--rams-gray-500);
      margin-top: var(--rams-space-4);
    }

    /* Activity Pulse Indicator */
    .wizard-activity-pulse {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: var(--rams-accent);
      border-radius: 50%;
      animation: wizard-pulse 1.5s ease-in-out infinite;
    }

    @keyframes wizard-pulse {
      0%, 100% { opacity: 0.4; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .wizard-activity-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--rams-gray-600);
      margin-top: var(--rams-space-3);
    }

    /* Time Info Display */
    .wizard-time-info {
      display: flex;
      align-items: center;
      gap: var(--rams-space-2);
      font-size: 13px;
      margin-top: var(--rams-space-3);
    }

    #wizard-elapsed-time {
      font-weight: 600;
      color: var(--rams-gray-700);
    }

    .wizard-time-typical {
      color: var(--rams-gray-500);
    }

    /* Stuck Warning Dialog */
    .wizard-stuck-dialog {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--rams-white);
      border-radius: var(--rams-radius-lg);
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: var(--rams-space-6);
      max-width: 400px;
      z-index: 1001;
    }

    .wizard-stuck-content {
      text-align: center;
    }

    .wizard-stuck-icon {
      font-size: 48px;
      margin-bottom: var(--rams-space-4);
    }

    .wizard-stuck-content h4 {
      margin: 0 0 var(--rams-space-3);
      color: var(--rams-gray-900);
    }

    .wizard-stuck-content p {
      color: var(--rams-gray-600);
      margin: 0 0 var(--rams-space-2);
    }

    .wizard-stuck-hint {
      font-size: 13px;
      color: var(--rams-gray-500);
    }

    .wizard-stuck-actions {
      display: flex;
      gap: var(--rams-space-3);
      justify-content: center;
      margin-top: var(--rams-space-5);
    }

    /* Generation Actions */
    .wizard-generation-actions {
      display: flex;
      justify-content: center;
      margin-top: var(--rams-space-4);
      padding-top: var(--rams-space-3);
      border-top: 1px solid var(--rams-gray-200);
    }

    /* PRD Editor Styles */
    .wizard-editor-container {
      display: flex;
      flex-direction: column;
      height: 450px;
      border: 1px solid var(--rams-gray-200);
      border-radius: var(--rams-radius-lg);
      overflow: hidden;
    }

    .wizard-editor-tabs {
      display: flex;
      gap: 0;
      background: var(--rams-gray-50);
      border-bottom: 1px solid var(--rams-gray-200);
    }

    .wizard-editor-tab {
      flex: 1;
      padding: var(--rams-space-3) var(--rams-space-4);
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      font-weight: 600;
      font-size: 13px;
      color: var(--rams-gray-600);
      cursor: pointer;
      transition: all var(--rams-transition-fast);
    }

    .wizard-editor-tab:hover {
      color: var(--rams-gray-900);
      background: var(--rams-gray-100);
    }

    .wizard-editor-tab.active {
      color: var(--rams-accent);
      border-bottom-color: var(--rams-accent);
      background: var(--rams-white);
    }

    .wizard-editor-pane {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .wizard-editor-pane.active {
      display: flex;
    }

    .wizard-editor-code {
      flex: 1;
      padding: var(--rams-space-3);
      font-family: 'SF Mono', monospace;
      font-size: 13px;
      overflow: auto;
      resize: none;
      border: none;
      background: var(--rams-white);
    }

    .wizard-editor-preview {
      flex: 1;
      padding: var(--rams-space-4);
      overflow: auto;
      background: var(--rams-white);
    }

    .wizard-editor-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--rams-space-2) var(--rams-space-3);
      background: var(--rams-gray-50);
      border-top: 1px solid var(--rams-gray-200);
      font-size: 12px;
      color: var(--rams-gray-500);
    }

    /* Build Config Styles */
    .wizard-form-group {
      margin-bottom: var(--rams-space-5);
    }

    .wizard-form-label {
      display: block;
      font-weight: 600;
      margin-bottom: var(--rams-space-2);
      color: var(--rams-gray-900);
    }

    .wizard-form-help {
      font-size: 13px;
      color: var(--rams-gray-500);
      margin-top: var(--rams-space-1);
    }

    .wizard-radio-group {
      display: flex;
      flex-direction: column;
      gap: var(--rams-space-3);
    }

    .wizard-radio-option {
      display: flex;
      align-items: flex-start;
      gap: var(--rams-space-3);
      padding: var(--rams-space-4);
      border: 2px solid var(--rams-gray-200);
      border-radius: var(--rams-radius-lg);
      cursor: pointer;
      transition: all var(--rams-transition-fast);
    }

    .wizard-radio-option:hover {
      border-color: var(--rams-gray-300);
      background: var(--rams-gray-50);
    }

    .wizard-radio-option.selected {
      border-color: var(--rams-accent);
      background: rgba(26, 77, 46, 0.04);
    }

    .wizard-radio-option input[type="radio"] {
      margin-top: 2px;
    }

    .wizard-radio-content {
      flex: 1;
    }

    .wizard-radio-title {
      font-weight: 600;
      color: var(--rams-gray-900);
    }

    .wizard-radio-desc {
      font-size: 13px;
      color: var(--rams-gray-600);
      margin-top: var(--rams-space-1);
    }

  </style>
</head>
<body class="rams-page">

  <script src="/js/sidebar.js"></script>

  <!-- Persistent Sidebar -->
  <aside class="rams-sidebar" id="rams-sidebar">
    <div class="rams-sidebar-header">
      <div class="rams-logo">
        <div class="rams-logo-mark" onclick="toggleSidebar()" title="Toggle sidebar"></div>
        <span class="rams-logo-text">RALPH</span>
      </div>
    </div>

    <nav class="rams-nav">
      <div class="rams-nav-section">
        <div class="rams-nav-label">Main</div>
        <ul class="rams-nav-items">
          <li><a href="/" class="rams-nav-link">Home</a></li>
          <li><a href="/dashboard.html" class="rams-nav-link">Dashboard</a></li>
          <li><a href="/streams.html" class="rams-nav-link active">Streams</a></li>
          <li><a href="/docs/" class="rams-nav-link">Documentation</a></li>
        </ul>
      </div>

      <div class="rams-nav-section">
        <div class="rams-nav-label">Monitoring</div>
        <ul class="rams-nav-items">
          <li><a href="/logs.html" class="rams-nav-link">Logs</a></li>
          <li><a href="/tokens.html" class="rams-nav-link">Tokens</a></li>
          <li><a href="/trends.html" class="rams-nav-link">Trends</a></li>
        </ul>
      </div>

      <div class="rams-nav-section">
        <div class="rams-nav-label">Tools</div>
        <ul class="rams-nav-items">
          <li><a href="/editor.html" class="rams-nav-link">Editor</a></li>
          <li><a href="/chat.html" class="rams-nav-link">Chat</a></li>
        </ul>
      </div>

      <div class="rams-nav-section">
        <div class="rams-nav-label">Advanced</div>
        <ul class="rams-nav-items">
          <li><a href="/docs/agent-guide.html" class="rams-nav-link">Agent Guide</a></li>
        </ul>
      </div>
    </nav>

    <div class="rams-sidebar-footer">
      <div class="rams-version">v1.0.0</div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="rams-main">

    <!-- Top Bar -->
    <div class="rams-topbar">
      <div class="rams-breadcrumb">
        <span class="rams-breadcrumb-current">Streams</span>
      </div>
      <div class="rams-topbar-actions">
        <button
          id="streams-view-toggle"
          class="rams-btn rams-btn-secondary"
          onclick="toggleStreamsView()"
          title="Switch to Progress View"
        >
          üìä Progress View
        </button>
        <button
          id="toggle-closed-btn"
          class="rams-btn rams-btn-secondary"
          onclick="toggleClosedStreams()"
        >
          Show Closed
        </button>
        <button
          class="rams-btn rams-btn-primary"
          onclick="openWizard()"
        >
          + New Stream
        </button>
      </div>
    </div>

    <!-- Content Area -->
    <article class="rams-content">

      <!-- Alert Container -->
      <div id="alert-container"></div>

      <!-- Tab Navigation -->
      <div class="rams-tabs">
        <button class="rams-tab active" onclick="switchTab('monitor')">
          Monitor
        </button>
        <button class="rams-tab" onclick="switchTab('documentation')">
          Documentation
        </button>
      </div>

      <!-- Monitor Tab Content -->
      <div id="monitor-tab" class="rams-tab-content active">

        <!-- Streams Overview Section -->
        <section class="rams-section">
          <div class="rams-section-header">
            <h2 class="rams-h2">
              Streams Overview
              <span class="htmx-indicator" id="summary-indicator">
                <span class="rams-spinner"></span>
              </span>
            </h2>
          </div>
          <div
            id="streams-summary"
            hx-get="/api/partials/streams-summary"
            hx-trigger="load, every 5s"
            hx-swap="innerHTML"
            hx-indicator="#summary-indicator"
          >
            <div class="rams-loading">
              <span class="rams-spinner"></span> Loading streams summary...
            </div>
          </div>
        </section>

        <!-- Streams List Section -->
        <section class="rams-section">
          <div class="rams-section-header">
            <h2 class="rams-h2">
              All Streams
              <span class="htmx-indicator" id="streams-indicator">
                <span class="rams-spinner"></span>
              </span>
            </h2>
          </div>
          <div
            id="streams-container"
            hx-get="/api/partials/streams"
            hx-trigger="load, every 5s, newStreamCreated from:body"
            hx-swap="innerHTML"
            hx-indicator="#streams-indicator"
          >
            <div class="rams-loading">
              <span class="rams-spinner"></span> Loading streams...
            </div>
          </div>
        </section>

        <!-- Stream Detail Section (shown when a stream is selected) -->
        <section id="stream-detail-section" class="rams-section rams-hidden">
          <div class="rams-section-header">
            <div style="display: flex; align-items: center; gap: var(--rams-space-3); margin-bottom: var(--rams-space-4);">
              <button
                type="button"
                onclick="hideStreamDetail()"
                class="rams-btn rams-btn-secondary"
                style="padding: var(--rams-space-2) var(--rams-space-3);"
              >
                ‚Üê Back to Streams
              </button>
              <h2 class="rams-h2" id="stream-detail-title" style="margin: 0;">Stream Detail</h2>
            </div>
          </div>
          <div id="stream-detail-container">
            <!-- Stream detail content loaded via HTMX -->
          </div>
        </section>

      </div>

      <!-- Documentation Tab Content -->
      <div id="documentation-tab" class="rams-tab-content">

        <!-- Introduction -->
        <div class="rams-step">
          <div class="rams-step-header">
            <div class="rams-step-info">
              <h2 class="rams-h2">What Are Streams?</h2>
              <p class="rams-subtitle">Parallel execution for faster development</p>
            </div>
          </div>
          <div class="rams-step-body">
            <div class="rams-section">
              <p class="rams-text">
                Streams allow you to run multiple PRD builds in parallel, each in complete isolation.
                Think of it like having multiple workbenches in a workshop - each craftsperson can work
                on their own project simultaneously without interfering with others.
              </p>
              <div class="rams-info-box">
                <div class="rams-info-icon">i</div>
                <div class="rams-info-content">
                  <div class="rams-info-title">Key Benefits</div>
                  <ul>
                    <li><strong>Speed:</strong> Build multiple PRDs simultaneously (40-55% time savings)</li>
                    <li><strong>Isolation:</strong> Each stream has its own working directory</li>
                    <li><strong>Safety:</strong> Built-in locks and validation prevent conflicts</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Start -->
        <div class="rams-step">
          <div class="rams-step-header">
            <div style="flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--rams-accent); color: var(--rams-white); border-radius: 50%; font-weight: 600; font-size: var(--rams-text-sm); font-family: var(--rams-font-mono);">1</div>
            <div class="rams-step-info">
              <h2 class="rams-h2">Quick Start Guide</h2>
              <p class="rams-subtitle">Get started with parallel streams in 5 steps</p>
            </div>
          </div>
          <div class="rams-step-body">
            <div class="rams-section">
              <h3 class="rams-h3">Step 1: Create Multiple PRDs</h3>
              <div class="rams-code-block">
                <div class="rams-code-header">
                  <span class="rams-code-label">Terminal</span>
                  <button class="rams-code-copy" onclick="copyToClipboard(this, 'ralph prd  # Creates PRD-1\nralph prd  # Creates PRD-2\n# Edit .ralph/PRD-N/prd.md for each')">
                    <span>Copy</span>
                  </button>
                </div>
                <div class="rams-code-content">
                  <pre><code>ralph prd  # Creates PRD-1
ralph prd  # Creates PRD-2
# Edit .ralph/PRD-N/prd.md for each</code></pre>
                </div>
              </div>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">Step 2: Create Plans</h3>
              <div class="rams-code-block">
                <div class="rams-code-header">
                  <span class="rams-code-label">Terminal</span>
                  <button class="rams-code-copy" onclick="copyToClipboard(this, 'ralph plan --prd=1\nralph plan --prd=2')">
                    <span>Copy</span>
                  </button>
                </div>
                <div class="rams-code-content">
                  <pre><code>ralph plan --prd=1
ralph plan --prd=2</code></pre>
                </div>
              </div>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">Step 3: Initialize Worktrees</h3>
              <div class="rams-code-block">
                <div class="rams-code-header">
                  <span class="rams-code-label">Terminal</span>
                  <button class="rams-code-copy" onclick="copyToClipboard(this, 'ralph stream init 1  # Creates branch ralph/PRD-1\nralph stream init 2  # Creates branch ralph/PRD-2')">
                    <span>Copy</span>
                  </button>
                </div>
                <div class="rams-code-content">
                  <pre><code>ralph stream init 1  # Creates branch ralph/PRD-1
ralph stream init 2  # Creates branch ralph/PRD-2</code></pre>
                </div>
              </div>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">Step 4: Build in Parallel</h3>
              <div class="rams-code-block">
                <div class="rams-code-header">
                  <span class="rams-code-label">Terminal</span>
                  <button class="rams-code-copy" onclick="copyToClipboard(this, 'ralph stream build 1 5 &  # Run in background\nralph stream build 2 5 &  # Run in background\nralph stream status      # Monitor progress')">
                    <span>Copy</span>
                  </button>
                </div>
                <div class="rams-code-content">
                  <pre><code>ralph stream build 1 5 &  # Run in background
ralph stream build 2 5 &  # Run in background
ralph stream status      # Monitor progress</code></pre>
                </div>
              </div>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">Step 5: Merge When Complete</h3>
              <div class="rams-code-block">
                <div class="rams-code-header">
                  <span class="rams-code-label">Terminal</span>
                  <button class="rams-code-copy" onclick="copyToClipboard(this, 'ralph stream merge 1\nralph stream merge 2')">
                    <span>Copy</span>
                  </button>
                </div>
                <div class="rams-code-content">
                  <pre><code>ralph stream merge 1
ralph stream merge 2</code></pre>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Architecture -->
        <div class="rams-step">
          <div class="rams-step-header">
            <div style="flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--rams-accent); color: var(--rams-white); border-radius: 50%; font-weight: 600; font-size: var(--rams-text-sm); font-family: var(--rams-font-mono);">2</div>
            <div class="rams-step-info">
              <h2 class="rams-h2">Stream Architecture</h2>
              <p class="rams-subtitle">Understanding isolated execution layers</p>
            </div>
          </div>
          <div class="rams-step-body">
            <div class="rams-section">
              <p class="rams-text">Each stream operates in isolated layers:</p>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">Git Branches</h3>
              <div class="rams-code-block">
                <div class="rams-code-header">
                  <span class="rams-code-label">Branch Structure</span>
                  <button class="rams-code-copy" onclick="copyToClipboard(this, 'ralph/PRD-1  - Feature branch for PRD 1\nralph/PRD-2  - Feature branch for PRD 2\nralph/PRD-3  - Feature branch for PRD 3')">
                    <span>Copy</span>
                  </button>
                </div>
                <div class="rams-code-content">
                  <pre><code>ralph/PRD-1  - Feature branch for PRD 1
ralph/PRD-2  - Feature branch for PRD 2
ralph/PRD-3  - Feature branch for PRD 3</code></pre>
                </div>
              </div>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">Worktrees (Isolated Directories)</h3>
              <div class="rams-code-block">
                <div class="rams-code-header">
                  <span class="rams-code-label">Directory Structure</span>
                  <button class="rams-code-copy" onclick="copyToClipboard(this, '.ralph/worktrees/PRD-1/  - Complete repo checkout on ralph/PRD-1\n.ralph/worktrees/PRD-2/  - Complete repo checkout on ralph/PRD-2\n.ralph/worktrees/PRD-3/  - Complete repo checkout on ralph/PRD-3')">
                    <span>Copy</span>
                  </button>
                </div>
                <div class="rams-code-content">
                  <pre><code>.ralph/worktrees/PRD-1/  - Complete repo checkout on ralph/PRD-1
.ralph/worktrees/PRD-2/  - Complete repo checkout on ralph/PRD-2
.ralph/worktrees/PRD-3/  - Complete repo checkout on ralph/PRD-3</code></pre>
                </div>
              </div>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">Safety Mechanisms</h3>
              <ul>
                <li><strong>Lock Files:</strong> Prevent concurrent builds of same PRD</li>
                <li><strong>Status Validation:</strong> Git history is source of truth</li>
                <li><strong>Merge Queue:</strong> Only one merge to main at a time</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Understanding Worktrees -->
        <div class="rams-step">
          <div class="rams-step-header">
            <div style="flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--rams-accent); color: var(--rams-white); border-radius: 50%; font-weight: 600; font-size: var(--rams-text-sm); font-family: var(--rams-font-mono);">3</div>
            <div class="rams-step-info">
              <h2 class="rams-h2">Understanding Worktrees</h2>
              <p class="rams-subtitle">Multiple working directories from the same repository</p>
            </div>
          </div>
          <div class="rams-step-body">
            <div class="rams-section">
              <p class="rams-text">
                Worktrees are Git's feature for having multiple working directories from the same repository.
                Traditional Git requires switching branches, which changes all your files. With worktrees,
                you can have multiple branches checked out simultaneously in different directories.
              </p>
            </div>

            <div class="rams-section">
              <div class="rams-info-box">
                <div class="rams-info-icon">i</div>
                <div class="rams-info-content">
                  <div class="rams-info-title">The Office Analogy</div>
                  <p class="rams-text-sm">
                    <strong>Traditional Git:</strong> One desk. To work on a different project, clear your desk and bring out new files.
                  </p>
                  <p class="rams-text-sm">
                    <strong>With Worktrees:</strong> Multiple desks in different rooms. Walk between rooms and work on whichever project you want.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Safety Features -->
        <div class="rams-step">
          <div class="rams-step-header">
            <div style="flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--rams-accent); color: var(--rams-white); border-radius: 50%; font-weight: 600; font-size: var(--rams-text-sm); font-family: var(--rams-font-mono);">4</div>
            <div class="rams-step-info">
              <h2 class="rams-h2">Safety Features</h2>
              <p class="rams-subtitle">Built-in conflict prevention and validation</p>
            </div>
          </div>
          <div class="rams-step-body">
            <div class="rams-section">
              <h3 class="rams-h3">Lock Files</h3>
              <p class="rams-text">Each stream gets a lock file when a build starts, preventing duplicate runs:</p>
              <div class="rams-code-block">
                <div class="rams-code-header">
                  <span class="rams-code-label">Lock File Structure</span>
                  <button class="rams-code-copy" onclick="copyToClipboard(this, '.ralph/locks/PRD-N.lock  # Contains process ID (PID)\n- Created when build starts\n- Validated before each build\n- Stale locks auto-removed')">
                    <span>Copy</span>
                  </button>
                </div>
                <div class="rams-code-content">
                  <pre><code>.ralph/locks/PRD-N.lock  # Contains process ID (PID)
- Created when build starts
- Validated before each build
- Stale locks auto-removed</code></pre>
                </div>
              </div>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">Status Validation</h3>
              <p class="rams-text">Ralph cross-checks file markers against Git history:</p>
              <ul>
                <li>Git is the source of truth, not file markers</li>
                <li>Auto-corrects missing .merged markers</li>
                <li>Detects and fixes stale status</li>
              </ul>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">Merge Queue</h3>
              <p class="rams-text">Only one stream can merge to main at a time:</p>
              <div class="rams-code-block">
                <div class="rams-code-header">
                  <span class="rams-code-label">Merge Lock</span>
                  <button class="rams-code-copy" onclick="copyToClipboard(this, '# Global lock prevents parallel merges\n.ralph/locks/merge.lock\n- Auto-cleanup if process dies\n- 5-minute max wait timeout')">
                    <span>Copy</span>
                  </button>
                </div>
                <div class="rams-code-content">
                  <pre><code># Global lock prevents parallel merges
.ralph/locks/merge.lock
- Auto-cleanup if process dies
- 5-minute max wait timeout</code></pre>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- When to Use Streams -->
        <div class="rams-step">
          <div class="rams-step-header">
            <div style="flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--rams-accent); color: var(--rams-white); border-radius: 50%; font-weight: 600; font-size: var(--rams-text-sm); font-family: var(--rams-font-mono);">5</div>
            <div class="rams-step-info">
              <h2 class="rams-h2">When to Use Streams</h2>
              <p class="rams-subtitle">Optimal scenarios for parallel execution</p>
            </div>
          </div>
          <div class="rams-step-body">
            <div class="rams-section">
              <h3 class="rams-h3">‚úì Use Streams When:</h3>
              <ul>
                <li>Features touch different files (no overlap)</li>
                <li>Multiple features needed for same deadline</li>
                <li>Long-running builds (30+ minutes each)</li>
                <li>Team collaboration on separate features</li>
              </ul>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">‚úó Avoid Streams When:</h3>
              <ul>
                <li>Sequential dependencies (PRD-2 needs PRD-1 first)</li>
                <li>Multiple PRDs modifying same files</li>
                <li>Quick fixes (1-2 iterations only)</li>
                <li>Learning Ralph (master sequential builds first)</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Performance -->
        <div class="rams-step">
          <div class="rams-step-header">
            <div style="flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--rams-accent); color: var(--rams-white); border-radius: 50%; font-weight: 600; font-size: var(--rams-text-sm); font-family: var(--rams-font-mono);">6</div>
            <div class="rams-step-info">
              <h2 class="rams-h2">Performance Tips</h2>
              <p class="rams-subtitle">Maximizing speed and efficiency</p>
            </div>
          </div>
          <div class="rams-step-body">
            <div class="rams-section">
              <h3 class="rams-h3">Optimal Configuration</h3>
              <div class="rams-info-box">
                <div class="rams-info-icon">i</div>
                <div class="rams-info-content">
                  <div class="rams-info-title">Recommended: 2-3 parallel streams</div>
                  <p class="rams-text-sm">
                    Best speed vs complexity trade-off. Manageable on most laptops (4GB+ RAM).
                    Low risk of rate limiting.
                  </p>
                </div>
              </div>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">Time Savings</h3>
              <ul>
                <li>2 medium PRDs: ~35 min sequential ‚Üí ~20 min parallel (43% faster)</li>
                <li>3 small PRDs: ~30 min sequential ‚Üí ~15 min parallel (50% faster)</li>
                <li>4 small PRDs: ~40 min sequential ‚Üí ~18 min parallel (55% faster)</li>
              </ul>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">Optimization Tips</h3>
              <ul>
                <li>Stagger starts 1-2 minutes apart to avoid API burst</li>
                <li>Group small PRDs together, large PRDs separately</li>
                <li>Monitor logs in .ralph/PRD-N/runs/</li>
                <li>Merge completed streams immediately to free resources</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Common Commands -->
        <div class="rams-step">
          <div class="rams-step-header">
            <div class="rams-step-info">
              <h2 class="rams-h2">Common Commands Reference</h2>
              <p class="rams-subtitle">Quick reference for stream operations</p>
            </div>
          </div>
          <div class="rams-step-body">
            <div class="rams-section">
              <h3 class="rams-h3">Stream Management</h3>
              <div class="rams-code-block">
                <div class="rams-code-header">
                  <span class="rams-code-label">Terminal</span>
                  <button class="rams-code-copy" onclick="copyToClipboard(this, 'ralph stream list          # List all streams\nralph stream status        # Show stream status\nralph stream init N        # Initialize worktree for PRD-N')">
                    <span>Copy</span>
                  </button>
                </div>
                <div class="rams-code-content">
                  <pre><code>ralph stream list          # List all streams
ralph stream status        # Show stream status
ralph stream init N        # Initialize worktree for PRD-N</code></pre>
                </div>
              </div>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">Building</h3>
              <div class="rams-code-block">
                <div class="rams-code-header">
                  <span class="rams-code-label">Terminal</span>
                  <button class="rams-code-copy" onclick="copyToClipboard(this, 'ralph stream build N 5     # Build PRD-N for 5 iterations\nralph stream build N 5 --no-worktree  # Build without worktree\nralph stream build N 5 --force        # Force build (ignore locks)')">
                    <span>Copy</span>
                  </button>
                </div>
                <div class="rams-code-content">
                  <pre><code>ralph stream build N 5     # Build PRD-N for 5 iterations
ralph stream build N 5 --no-worktree  # Build without worktree
ralph stream build N 5 --force        # Force build (ignore locks)</code></pre>
                </div>
              </div>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">Merging</h3>
              <div class="rams-code-block">
                <div class="rams-code-header">
                  <span class="rams-code-label">Terminal</span>
                  <button class="rams-code-copy" onclick="copyToClipboard(this, 'ralph stream merge N       # Merge PRD-N to main')">
                    <span>Copy</span>
                  </button>
                </div>
                <div class="rams-code-content">
                  <pre><code>ralph stream merge N       # Merge PRD-N to main</code></pre>
                </div>
              </div>
            </div>

            <div class="rams-section">
              <h3 class="rams-h3">Status Management</h3>
              <div class="rams-code-block">
                <div class="rams-code-header">
                  <span class="rams-code-label">Terminal</span>
                  <button class="rams-code-copy" onclick="copyToClipboard(this, 'ralph stream mark-completed N    # Mark as completed\nralph stream verify-status       # Auto-fix stale status')">
                    <span>Copy</span>
                  </button>
                </div>
                <div class="rams-code-content">
                  <pre><code>ralph stream mark-completed N    # Mark as completed
ralph stream verify-status       # Auto-fix stale status</code></pre>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

    </article>

  </main>

  <!-- New Stream Wizard Modal -->
  <div id="new-stream-wizard" class="wizard-overlay rams-hidden">
    <div class="wizard-container">
      <div class="wizard-header">
        <h2>Create New Stream</h2>
        <button onclick="closeWizard()" class="wizard-close">&times;</button>
      </div>

      <div class="wizard-progress">
        <div class="wizard-step active" data-step="1">
          <div class="wizard-step-circle"><span class="wizard-step-number">1</span></div>
          <span class="wizard-step-label">Describe</span>
        </div>
        <div class="wizard-step-connector"></div>
        <div class="wizard-step" data-step="2">
          <div class="wizard-step-circle"><span class="wizard-step-number">2</span></div>
          <span class="wizard-step-label">Review PRD</span>
        </div>
        <div class="wizard-step-connector"></div>
        <div class="wizard-step" data-step="3">
          <div class="wizard-step-circle"><span class="wizard-step-number">3</span></div>
          <span class="wizard-step-label">Plan</span>
        </div>
        <div class="wizard-step-connector"></div>
        <div class="wizard-step" data-step="4">
          <div class="wizard-step-circle"><span class="wizard-step-number">4</span></div>
          <span class="wizard-step-label">Configure</span>
        </div>
        <div class="wizard-step-connector"></div>
        <div class="wizard-step" data-step="5">
          <div class="wizard-step-circle"><span class="wizard-step-number">5</span></div>
          <span class="wizard-step-label">Launch</span>
        </div>
      </div>

      <div id="wizard-content" class="wizard-body">
        <!-- Step content loaded dynamically -->
      </div>

      <div class="wizard-footer">
        <div class="wizard-footer-left">
          <button id="wizard-back-btn" class="rams-btn rams-btn-secondary rams-hidden" onclick="wizardBack()">
            ‚Üê Back
          </button>
        </div>
        <div class="wizard-footer-right">
          <button id="wizard-cancel-btn" class="rams-btn rams-btn-secondary" onclick="closeWizard()">
            Cancel
          </button>
          <button id="wizard-next-btn" class="rams-btn rams-btn-primary" onclick="wizardNext()">
            Next ‚Üí
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Toast -->
  <div id="error-toast" class="rams-alert rams-alert-error rams-hidden" style="position: fixed; bottom: var(--rams-space-6); right: var(--rams-space-6); max-width: 400px; z-index: 1000; box-shadow: var(--rams-shadow-lg);">
    <div style="display: flex; justify-content: space-between; align-items: start; gap: var(--rams-space-4);">
      <div style="flex: 1;">
        <div style="font-weight: 600; margin-bottom: var(--rams-space-1);">Error</div>
        <div id="error-toast-message" class="rams-text-sm"></div>
      </div>
      <button onclick="dismissErrorToast()" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 20px; line-height: 1;">&times;</button>
    </div>
  </div>

  <script>
    // Tab Switching
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.rams-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.rams-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + '-tab').classList.add('active');

      // Store active tab in localStorage
      localStorage.setItem('activeStreamsTab', tabName);
    }

    // Restore active tab on page load
    document.addEventListener('DOMContentLoaded', function() {
      const activeTab = localStorage.getItem('activeStreamsTab') || 'monitor';
      if (activeTab === 'documentation') {
        document.querySelector('.rams-tab[onclick*="documentation"]').click();
      }
    });

    // Copy to clipboard function for documentation code blocks
    function copyToClipboard(button, text) {
      // Copy text to clipboard
      navigator.clipboard.writeText(text).then(() => {
        // Visual feedback
        const span = button.querySelector('span');
        const originalText = span.textContent;
        span.textContent = 'Copied!';
        button.classList.add('copied');

        // Reset after 2 seconds
        setTimeout(() => {
          span.textContent = originalText;
          button.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy text:', err);
        const span = button.querySelector('span');
        span.textContent = 'Failed';
        setTimeout(() => {
          span.textContent = 'Copy';
        }, 2000);
      });
    }

    // Show stream detail view with smooth transition
    function showStreamDetail(streamId, streamName) {
      var overview = document.getElementById("streams-overview");
      var listSection = document.getElementById("streams-list-section");

      // Fade out grid
      overview.classList.add("rams-hidden");
      if (listSection) listSection.classList.add("rams-hidden");

      // Wait for fade, then hide
      setTimeout(function() {
        overview.style.display = "none";
        if (listSection) listSection.style.display = "none";

        // Show detail section
        var detailSection = document.getElementById("stream-detail-section");
        detailSection.classList.remove("rams-hidden");
        detailSection.style.display = "block";
        document.getElementById("stream-detail-title").textContent = streamName;

        // Load stream detail content via HTMX
        htmx.ajax("GET", "/api/partials/stream-detail?id=" + streamId, "#stream-detail-container");
      }, 200); // Match transition duration
    }

    // Show stream detail view and switch to estimate tab
    function showStreamDetailAndEstimate(streamId, streamName) {
      showStreamDetail(streamId, streamName);

      // Wait for HTMX to load the content, then switch to estimate tab
      setTimeout(function() {
        var estimateTab = document.querySelector('.stream-tab[onclick*="estimate"]');
        if (estimateTab) {
          estimateTab.click();
        }
      }, 300);
    }

    // Hide stream detail view and show streams list with smooth transition
    function hideStreamDetail() {
      var detailSection = document.getElementById("stream-detail-section");
      detailSection.classList.add("rams-hidden");

      setTimeout(function() {
        detailSection.style.display = "none";

        var overview = document.getElementById("streams-overview");
        var listSection = document.querySelector(".rams-section:nth-of-type(2)");

        if (overview) {
          overview.style.display = "block";
          overview.classList.remove("rams-hidden");
        }

        if (listSection) {
          listSection.style.display = "block";
          listSection.classList.remove("rams-hidden");
        }
      }, 200); // Match transition duration
    }

    // Close a stream (mark as inactive)
    async function closeStream(streamId, event) {
      event.stopPropagation();
      if (!confirm('Close PRD-' + streamId + '? This PRD will be hidden from the list. You can restore it later.')) {
        return;
      }

      try {
        const response = await fetch('/api/streams/' + streamId + '/close', { method: 'POST' });
        if (response.ok) {
          showAlert('success', 'PRD-' + streamId + ' closed successfully', 3000);
          htmx.ajax('GET', '/api/partials/streams', { target: '#streams-container', swap: 'innerHTML' });
        } else {
          const error = await response.json();
          showAlert('error', 'Failed to close: ' + error.message, 5000);
        }
      } catch (error) {
        showAlert('error', 'Failed to close: ' + error.message, 5000);
      }
    }

    // Restore a closed stream
    async function restoreStream(streamId, event) {
      event.stopPropagation();
      try {
        const response = await fetch('/api/streams/' + streamId + '/restore', { method: 'POST' });
        if (response.ok) {
          showAlert('success', 'PRD-' + streamId + ' restored', 3000);
          htmx.ajax('GET', '/api/partials/streams', { target: '#streams-container', swap: 'innerHTML' });
        } else {
          const error = await response.json();
          showAlert('error', 'Failed to restore: ' + error.message, 5000);
        }
      } catch (error) {
        showAlert('error', 'Failed to restore: ' + error.message, 5000);
      }
    }

    // Toggle showing closed streams
    function toggleClosedStreams() {
      const showClosed = localStorage.getItem('showClosedStreams') === 'true';
      const newState = !showClosed;
      localStorage.setItem('showClosedStreams', newState);

      // Check current view mode to reload the correct endpoint
      const viewMode = localStorage.getItem('streamsViewMode') || 'grid';
      const baseUrl = viewMode === 'grid' ? '/api/partials/streams' : '/api/partials/streams-progress';
      const url = baseUrl + (newState ? '?showClosed=true' : '');

      htmx.ajax('GET', url, { target: '#streams-container', swap: 'innerHTML' });

      // Update button text
      const btn = document.getElementById('toggle-closed-btn');
      if (btn) btn.textContent = newState ? 'Hide Closed' : 'Show Closed';
    }

    // Initialize toggle button state on page load
    document.addEventListener('DOMContentLoaded', function() {
      const showClosed = localStorage.getItem('showClosedStreams') === 'true';
      const btn = document.getElementById('toggle-closed-btn');
      if (btn && showClosed) {
        btn.textContent = 'Hide Closed';
      }
    });

    // Show alert message
    function showAlert(type, message, duration) {
      var container = document.getElementById("alert-container");
      var alert = document.createElement("div");
      alert.className = "rams-alert rams-alert-" + type;
      alert.textContent = message;
      container.innerHTML = "";
      container.appendChild(alert);

      if (duration !== false) {
        setTimeout(function () {
          alert.remove();
        }, duration || 5000);
      }
    }

    // Handle new stream response
    function handleNewStreamResponse(event) {
      var xhr = event.detail.xhr;
      if (xhr && xhr.status === 200) {
        try {
          var response = JSON.parse(xhr.responseText);
          if (response.success) {
            showAlert("success", "Stream PRD-" + response.id + " created successfully!");
            // Trigger refresh of streams list
            htmx.trigger(document.body, "newStreamCreated");
            // Also refresh the summary
            htmx.ajax("GET", "/api/partials/streams-summary", "#streams-summary");
          }
        } catch (e) {
          // Response might be HTML partial, still refresh
          htmx.trigger(document.body, "newStreamCreated");
        }
      } else if (xhr) {
        try {
          var response = JSON.parse(xhr.responseText);
          showAlert("error", response.message || "Failed to create stream");
        } catch (e) {
          showAlert("error", "Failed to create stream");
        }
      }
    }

    // Initialize worktree for a stream
    function initStream(streamId, event) {
      if (event) event.stopPropagation();

      fetch("/api/stream/" + streamId + "/init", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      })
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          if (data.success) {
            showAlert("success", "Worktree initialized for PRD-" + streamId);
            htmx.trigger(document.body, "newStreamCreated");
          } else {
            showAlert("error", data.message || "Failed to initialize worktree");
          }
        })
        .catch(function (err) {
          showAlert("error", "Failed to initialize worktree: " + err.message);
        });
    }

    // Toggle build form visibility
    function toggleBuildForm(streamId, event) {
      if (event) event.stopPropagation();

      var formId = "build-form-" + streamId;
      var form = document.getElementById(formId);
      if (form) {
        form.style.display = form.style.display === "none" ? "flex" : "none";
      }
    }

    // Start build for a stream
    function startStreamBuild(streamId, event) {
      if (event) event.preventDefault();
      if (event) event.stopPropagation();

      var input = document.getElementById("iterations-" + streamId);
      var iterations = parseInt(input ? input.value : 1, 10);

      if (isNaN(iterations) || iterations < 1 || iterations > 100) {
        showAlert("error", "Iterations must be between 1 and 100");
        return;
      }

      fetch("/api/stream/" + streamId + "/build", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ iterations: iterations }),
      })
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          if (data.success) {
            showAlert(
              "success",
              "Build started for PRD-" + streamId + " with " + iterations + " iterations"
            );
            // Hide the build form
            var form = document.getElementById("build-form-" + streamId);
            if (form) form.style.display = "none";
            // Refresh streams list
            htmx.trigger(document.body, "newStreamCreated");
          } else {
            showAlert("error", data.message || "Failed to start build");
          }
        })
        .catch(function (err) {
          showAlert("error", "Failed to start build: " + err.message);
        });
    }

    // Merge stream to main branch
    function mergeStream(streamId, streamName, event) {
      if (event) event.stopPropagation();

      // Show confirmation dialog
      var confirmed = confirm(
        "Are you sure you want to merge stream PRD-" +
          streamId +
          ' to main?\n\nThis will merge all changes from "' +
          streamName +
          '" into the main branch.'
      );

      if (!confirmed) {
        return;
      }

      fetch("/api/stream/" + streamId + "/merge", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      })
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          if (data.success) {
            showAlert("success", "PRD-" + streamId + " merged to main successfully!");
            htmx.trigger(document.body, "newStreamCreated");
          } else {
            showAlert("error", data.message || "Failed to merge stream");
          }
        })
        .catch(function (err) {
          showAlert("error", "Failed to merge stream: " + err.message);
        });
    }

    // Pause a running stream build (graceful stop)
    function pauseStream(streamId, event) {
      if (event) event.stopPropagation();

      var confirmed = confirm(
        "Pause build for PRD-" + streamId + "?\n\nThis will gracefully stop after the current iteration completes."
      );

      if (!confirmed) {
        return;
      }

      fetch("/api/stream/" + streamId + "/stop", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ force: false })
      })
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          if (data.success) {
            showAlert("success", "Pause signal sent to PRD-" + streamId);
            htmx.trigger(document.body, "newStreamCreated");
          } else {
            showAlert("error", data.message || "Failed to pause build");
          }
        })
        .catch(function (err) {
          showAlert("error", "Failed to pause build: " + err.message);
        });
    }

    // Cancel a running stream build (force stop)
    function cancelStream(streamId, event) {
      if (event) event.stopPropagation();

      var confirmed = confirm(
        "Cancel build for PRD-" + streamId + "?\n\nThis will immediately terminate the build process. Any in-progress work may be lost."
      );

      if (!confirmed) {
        return;
      }

      fetch("/api/stream/" + streamId + "/stop", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ force: true })
      })
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          if (data.success) {
            showAlert("warning", "Build cancelled for PRD-" + streamId);
            htmx.trigger(document.body, "newStreamCreated");
          } else {
            showAlert("error", data.message || "Failed to cancel build");
          }
        })
        .catch(function (err) {
          showAlert("error", "Failed to cancel build: " + err.message);
        });
    }

    // Toggle build form in Progress View
    function toggleBuildFormProgress(streamId, event) {
      if (event) event.stopPropagation();
      var form = document.getElementById("build-form-progress-" + streamId);
      if (form) {
        form.style.display = form.style.display === "none" ? "block" : "none";
      }
    }

    // Start build from Progress View form
    function startStreamBuildProgress(streamId, event) {
      if (event) event.stopPropagation();

      var iterationsInput = document.getElementById("iterations-progress-" + streamId);
      var iterations = iterationsInput ? parseInt(iterationsInput.value, 10) : 1;

      if (iterations < 1 || iterations > 100) {
        showAlert("error", "Iterations must be between 1 and 100");
        return;
      }

      fetch("/api/stream/" + streamId + "/build", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ iterations: iterations })
      })
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          if (data.success) {
            showAlert("success", "Build started for PRD-" + streamId + " with " + iterations + " iteration(s)");
            toggleBuildFormProgress(streamId);
            htmx.trigger(document.body, "newStreamCreated");
          } else {
            showAlert("error", data.message || "Failed to start build");
          }
        })
        .catch(function (err) {
          showAlert("error", "Failed to start build: " + err.message);
        });
    }

    // Error Toast Management
    var lastFailedRequest = null;

    function showErrorToast(message, endpoint) {
      console.error("[Error]", message, endpoint ? "(Endpoint: " + endpoint + ")" : "");
      var toast = document.getElementById("error-toast");
      var messageEl = document.getElementById("error-toast-message");

      messageEl.textContent = message;
      toast.classList.remove("rams-hidden");

      setTimeout(function() {
        dismissErrorToast();
      }, 10000);
    }

    function dismissErrorToast() {
      var toast = document.getElementById("error-toast");
      toast.classList.add("rams-hidden");
    }

    // HTMX error handlers
    document.body.addEventListener("htmx:responseError", function (event) {
      var xhr = event.detail.xhr;
      var path = event.detail.pathInfo ? event.detail.pathInfo.requestPath : "unknown";

      var message = "Request failed";
      if (xhr && xhr.status) {
        if (xhr.status === 0) {
          message = "Unable to connect to server. Check if the server is running.";
        } else if (xhr.status === 404) {
          message = "Resource not found: " + path;
        } else if (xhr.status === 500) {
          message = "Server error occurred. Please try again.";
          try {
            var response = JSON.parse(xhr.responseText);
            if (response.message) {
              message = response.message;
            }
          } catch (e) {}
        } else {
          message = "Request failed with status " + xhr.status;
        }
      }

      lastFailedRequest = { element: event.target };
      showErrorToast(message, path);
    });

    document.body.addEventListener("htmx:sendError", function (event) {
      var path = event.detail.pathInfo ? event.detail.pathInfo.requestPath : "unknown";
      console.error("[HTMX Send Error] Failed to send request:", path, event.detail);
      lastFailedRequest = { element: event.target };
      showErrorToast("Network error: Unable to send request. Check your connection.", path);
    });

    document.body.addEventListener("htmx:timeout", function (event) {
      var path = event.detail.pathInfo ? event.detail.pathInfo.requestPath : "unknown";
      console.error("[HTMX Timeout] Request timed out:", path);
      lastFailedRequest = { element: event.target };
      showErrorToast("Request timed out. The server may be busy.", path);
    });

    // ============================================
    // PRESERVE PRD EXPANSION STATE ACROSS REFRESHES
    // ============================================

    // Storage for expanded PRD IDs
    var expandedPRDs = new Set();

    // Before HTMX swaps content, save which PRDs are expanded
    document.body.addEventListener("htmx:beforeSwap", function (event) {
      var target = event.detail.target;

      // Only handle streams-container refreshes
      if (target && target.id === "streams-container") {
        expandedPRDs.clear();

        // Find all open <details> elements with PRD data
        var openDetails = target.querySelectorAll('details.stream-item-expandable[open]');
        openDetails.forEach(function(details) {
          // Extract PRD ID from the label inside
          var label = details.querySelector('.rams-label');
          if (label) {
            var prdId = label.textContent.trim(); // e.g., "PRD-23"
            expandedPRDs.add(prdId);
          }
        });
      }
    });

    // After HTMX swaps content, restore expanded state
    document.body.addEventListener("htmx:afterSwap", function (event) {
      var target = event.detail.target;

      // Only handle streams-container refreshes
      if (target && target.id === "streams-container" && expandedPRDs.size > 0) {
        // Find all <details> elements and re-open the ones that were expanded
        var allDetails = target.querySelectorAll('details.stream-item-expandable');
        allDetails.forEach(function(details) {
          var label = details.querySelector('.rams-label');
          if (label) {
            var prdId = label.textContent.trim();
            if (expandedPRDs.has(prdId)) {
              details.setAttribute('open', '');
            }
          }
        });
      }
    });

    // ============================================
    // WIZARD CONTROLLER
    // ============================================

    // Stuck detection threshold (3 minutes)
    var STUCK_THRESHOLD_SECONDS = 180;
    var stuckWarningShown = false;

    // Wizard State
    var wizardState = {
      currentStep: 1,
      streamId: null,
      pid: null, // Process ID for reliable cancellation
      data: {
        description: '',
        prdContent: '',
        planContent: '',
        iterations: 5,
        executionMode: 'isolated', // 'isolated' or 'direct'
        agent: 'claude'
      },
      isGenerating: false,
      eventSource: null,
      generationStartTime: null,
      lastOutputTime: null,
      timerInterval: null
    };

    // Step labels for the progress indicator
    var stepLabels = ['Describe', 'Review PRD', 'Plan', 'Configure', 'Launch'];

    // Open wizard modal
    function openWizard() {
      // Reset state
      wizardState = {
        currentStep: 1,
        streamId: null,
        pid: null,
        data: {
          description: '',
          prdContent: '',
          planContent: '',
          iterations: 5,
          executionMode: 'isolated',
          agent: 'claude'
        },
        isGenerating: false,
        eventSource: null,
        generationStartTime: null,
        lastOutputTime: null,
        timerInterval: null
      };
      stuckWarningShown = false;

      // Show modal
      document.getElementById('new-stream-wizard').classList.remove('rams-hidden');

      // Reset progress indicator
      updateProgressIndicator(1);

      // Render first step
      renderStep1();

      // Update footer buttons
      updateFooterButtons();
    }

    // Close wizard modal
    function closeWizard() {
      // Confirm if generation is in progress
      if (wizardState.isGenerating) {
        var confirmed = confirm('Generation is in progress. Are you sure you want to cancel?');
        if (!confirmed) return;
      }

      // Cleanup SSE connection
      if (wizardState.eventSource) {
        wizardState.eventSource.close();
        wizardState.eventSource = null;
      }

      // Cleanup generation state (timer, stuck dialog, etc.)
      cleanupGenerationState();

      // Hide modal
      document.getElementById('new-stream-wizard').classList.add('rams-hidden');

      // Reset state
      wizardState.isGenerating = false;
      wizardState.pid = null;
    }

    // Navigate to previous step
    function wizardBack() {
      if (wizardState.currentStep > 1 && !wizardState.isGenerating) {
        wizardState.currentStep--;
        updateProgressIndicator(wizardState.currentStep);
        renderCurrentStep();
        updateFooterButtons();
      }
    }

    // Navigate to next step or trigger generation
    function wizardNext() {
      if (wizardState.isGenerating) return;

      // Validate current step
      if (!validateCurrentStep()) return;

      // Handle step-specific actions
      switch (wizardState.currentStep) {
        case 1:
          // Save description and generate PRD
          saveStep1Data();
          generatePRD();
          break;
        case 2:
          // Save PRD edits and generate plan
          saveStep2Data();
          generatePlan();
          break;
        case 3:
          // Move to configure step
          wizardState.currentStep = 4;
          updateProgressIndicator(4);
          renderStep4();
          updateFooterButtons();
          break;
        case 4:
          // Save config and move to launch
          saveStep4Data();
          wizardState.currentStep = 5;
          updateProgressIndicator(5);
          renderStep5();
          updateFooterButtons();
          break;
        case 5:
          // Launch the build and redirect
          launchBuild();
          break;
      }
    }

    // Update progress indicator
    function updateProgressIndicator(step) {
      var steps = document.querySelectorAll('.wizard-step');
      steps.forEach(function(stepEl, index) {
        var stepNum = index + 1;
        stepEl.classList.remove('active', 'completed');

        if (stepNum < step) {
          stepEl.classList.add('completed');
        } else if (stepNum === step) {
          stepEl.classList.add('active');
        }
      });
    }

    // Update footer buttons based on current step
    function updateFooterButtons() {
      var backBtn = document.getElementById('wizard-back-btn');
      var nextBtn = document.getElementById('wizard-next-btn');
      var cancelBtn = document.getElementById('wizard-cancel-btn');

      // Back button visibility
      if (wizardState.currentStep === 1 || wizardState.isGenerating) {
        backBtn.classList.add('rams-hidden');
      } else {
        backBtn.classList.remove('rams-hidden');
      }

      // Disable back on step 5
      if (wizardState.currentStep === 5) {
        backBtn.disabled = true;
      } else {
        backBtn.disabled = false;
      }

      // Next button text
      var nextTexts = {
        1: 'Generate PRD',
        2: 'Generate Plan',
        3: 'Configure Build',
        4: 'Review & Launch',
        5: 'Start Building'
      };
      nextBtn.textContent = nextTexts[wizardState.currentStep] || 'Next';

      // Disable buttons during generation
      if (wizardState.isGenerating) {
        nextBtn.disabled = true;
        backBtn.disabled = true;
        cancelBtn.textContent = 'Cancel Generation';
      } else {
        nextBtn.disabled = false;
        cancelBtn.textContent = 'Cancel';
      }
    }

    // Render current step content
    function renderCurrentStep() {
      switch (wizardState.currentStep) {
        case 1: renderStep1(); break;
        case 2: renderStep2(); break;
        case 3: renderStep3(); break;
        case 4: renderStep4(); break;
        case 5: renderStep5(); break;
      }
    }

    // Validate current step
    function validateCurrentStep() {
      switch (wizardState.currentStep) {
        case 1:
          var desc = document.getElementById('wizard-description');
          if (!desc || desc.value.trim().length < 20) {
            showAlert('error', 'Please enter a description of at least 20 characters');
            return false;
          }
          return true;

        case 2:
          var prdEditor = document.getElementById('wizard-prd-editor');
          if (!prdEditor || prdEditor.value.trim().length === 0) {
            showAlert('error', 'PRD content cannot be empty');
            return false;
          }
          return true;

        case 3:
          // Plan must exist (already generated)
          if (!wizardState.data.planContent) {
            showAlert('error', 'Plan has not been generated yet');
            return false;
          }
          return true;

        case 4:
          var iterations = parseInt(document.getElementById('wizard-iterations').value, 10);
          if (isNaN(iterations) || iterations < 1 || iterations > 100) {
            showAlert('error', 'Iterations must be between 1 and 100');
            return false;
          }
          return true;

        case 5:
          return true;
      }
      return true;
    }

    // Save data from step 1
    function saveStep1Data() {
      var desc = document.getElementById('wizard-description');
      if (desc) {
        wizardState.data.description = desc.value.trim();
      }
    }

    // Save data from step 2
    function saveStep2Data() {
      var prdEditor = document.getElementById('wizard-prd-editor');
      if (prdEditor) {
        wizardState.data.prdContent = prdEditor.value;
      }
    }

    // Save data from step 4
    function saveStep4Data() {
      var iterations = document.getElementById('wizard-iterations');
      if (iterations) {
        wizardState.data.iterations = parseInt(iterations.value, 10);
      }

      var selectedMode = document.querySelector('input[name="execution-mode"]:checked');
      if (selectedMode) {
        wizardState.data.executionMode = selectedMode.value;
      }

      var agentSelect = document.getElementById('wizard-agent');
      if (agentSelect) {
        wizardState.data.agent = agentSelect.value;
      }
    }

    // ============================================
    // STEP RENDERING FUNCTIONS
    // ============================================

    // Step 1: Feature description
    function renderStep1() {
      var content = document.getElementById('wizard-content');
      content.innerHTML = '\
        <div class="wizard-step-content">\
          <h3>What would you like to build?</h3>\
          <p>Describe the feature or functionality you want to implement. Be specific about what it should do and any technical requirements.</p>\
          <textarea \
            id="wizard-description" \
            class="wizard-textarea" \
            placeholder="Example: Add a dark mode toggle to the settings page that persists user preference in localStorage and applies a dark theme across all components..."\
          >' + escapeHtml(wizardState.data.description) + '</textarea>\
          <div class="wizard-char-count">\
            <span id="wizard-char-count">' + wizardState.data.description.length + '</span> characters (minimum 20)\
          </div>\
        </div>\
      ';

      // Add character count listener
      var textarea = document.getElementById('wizard-description');
      if (textarea) {
        textarea.addEventListener('input', function() {
          document.getElementById('wizard-char-count').textContent = this.value.length;
        });
        textarea.focus();
      }
    }

    // Step 2: PRD editor with toggle view
    function renderStep2() {
      var content = document.getElementById('wizard-content');
      content.innerHTML = '\
        <div class="wizard-step-content">\
          <h3>Review & Edit PRD</h3>\
          <p>Review the generated PRD below. You can edit it to refine requirements before generating the plan.</p>\
          <div class="wizard-editor-container">\
            <div class="wizard-editor-tabs">\
              <button class="wizard-editor-tab active" onclick="switchEditorTab(\'editor\')">Markdown Editor</button>\
              <button class="wizard-editor-tab" onclick="switchEditorTab(\'preview\')">Preview</button>\
            </div>\
            <div id="wizard-editor-pane" class="wizard-editor-pane active">\
              <textarea id="wizard-prd-editor" class="wizard-editor-code">' + escapeHtml(wizardState.data.prdContent) + '</textarea>\
              <div class="wizard-editor-toolbar">\
                <span id="wizard-editor-status">Ready</span>\
                <button id="wizard-save-btn" class="rams-btn rams-btn-secondary" style="padding: 4px 12px; font-size: 12px;" onclick="savePrdContent()">Save Changes</button>\
              </div>\
            </div>\
            <div id="wizard-preview-pane" class="wizard-editor-pane">\
              <div id="wizard-prd-preview" class="wizard-editor-preview"></div>\
            </div>\
          </div>\
        </div>\
      ';

      // Render initial preview
      updatePrdPreview();

      // Add preview update listener
      var editor = document.getElementById('wizard-prd-editor');
      if (editor) {
        editor.addEventListener('input', function() {
          updatePrdPreview();
          markEditorDirty();
        });
      }

      // Fetch PRD content if not already loaded (with retry for timing issues)
      if (!wizardState.data.prdContent && wizardState.streamId) {
        var retryCount = 0;
        var maxRetries = 5;
        var retryDelay = 500;

        function fetchPrdWithRetry() {
          fetch('/api/stream/' + wizardState.streamId + '/prd')
            .then(function(r) {
              if (!r.ok) {
                if (retryCount < maxRetries) {
                  retryCount++;
                  setTimeout(fetchPrdWithRetry, retryDelay);
                  return Promise.reject('Retrying...');
                }
                return Promise.reject('Failed to fetch after retries');
              }
              return r.json();
            })
            .then(function(data) {
              if (data && data.content) {
                wizardState.data.prdContent = data.content;
                var editorEl = document.getElementById('wizard-prd-editor');
                if (editorEl) {
                  editorEl.value = data.content;
                }
                updatePrdPreview();
              }
            })
            .catch(function(e) {
              if (e !== 'Retrying...') {
                console.error('Failed to load PRD:', e);
              }
            });
        }
        fetchPrdWithRetry();
      }
    }

    // Update PRD preview (simple markdown rendering)
    function updatePrdPreview() {
      var editor = document.getElementById('wizard-prd-editor');
      var preview = document.getElementById('wizard-prd-preview');
      if (editor && preview) {
        preview.innerHTML = simpleMarkdownToHtml(editor.value);
      }
    }

    // Simple markdown to HTML converter
    function simpleMarkdownToHtml(md) {
      if (!md) return '';

      var html = escapeHtml(md);

      // Headers
      html = html.replace(/^### (.+)$/gm, '<h4 style="margin: 16px 0 8px; font-weight: 600;">$1</h4>');
      html = html.replace(/^## (.+)$/gm, '<h3 style="margin: 20px 0 10px; font-weight: 600;">$1</h3>');
      html = html.replace(/^# (.+)$/gm, '<h2 style="margin: 24px 0 12px; font-weight: 600;">$1</h2>');

      // Bold and italic
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

      // Checkboxes
      html = html.replace(/\[ \]/g, '<input type="checkbox" disabled>');
      html = html.replace(/\[x\]/gi, '<input type="checkbox" checked disabled>');

      // Lists
      html = html.replace(/^- (.+)$/gm, '<li style="margin-left: 20px;">$1</li>');

      // Line breaks
      html = html.replace(/\n\n/g, '</p><p style="margin: 12px 0;">');
      html = html.replace(/\n/g, '<br>');

      return '<div style="line-height: 1.6;"><p style="margin: 12px 0;">' + html + '</p></div>';
    }

    // Step 3: Plan view
    function renderStep3() {
      var content = document.getElementById('wizard-content');

      // Parse plan to show stories
      var stories = parsePlanStories(wizardState.data.planContent);
      var storiesHtml = '';

      if (stories.length > 0) {
        stories.forEach(function(story, index) {
          storiesHtml += '\
            <div style="padding: 12px; border: 1px solid var(--rams-gray-200); border-radius: 8px; margin-bottom: 8px;">\
              <div style="display: flex; align-items: center; gap: 8px;">\
                <span style="background: var(--rams-accent); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">US-' + String(index + 1).padStart(3, '0') + '</span>\
                <span style="font-weight: 500;">' + escapeHtml(story.title) + '</span>\
              </div>\
              ' + (story.tasks.length > 0 ? '\
              <div style="margin-top: 8px; padding-left: 16px; font-size: 13px; color: var(--rams-gray-600);">\
                ' + story.tasks.map(function(t) { return '<div>- ' + escapeHtml(t) + '</div>'; }).join('') + '\
              </div>' : '') + '\
            </div>\
          ';
        });
      } else {
        storiesHtml = '<p style="color: var(--rams-gray-500);">Plan content will appear here...</p>';
      }

      content.innerHTML = '\
        <div class="wizard-step-content">\
          <h3>Implementation Plan</h3>\
          <p>Review the generated plan. Each story will be implemented as a separate iteration during the build process.</p>\
          <div style="max-height: 400px; overflow-y: auto;">\
            ' + storiesHtml + '\
          </div>\
          <div style="margin-top: 16px; padding: 12px; background: var(--rams-gray-50); border-radius: 8px;">\
            <strong>Summary:</strong> ' + stories.length + ' stories to implement\
          </div>\
        </div>\
      ';
    }

    // Parse plan content to extract stories
    function parsePlanStories(planContent) {
      if (!planContent) return [];

      var stories = [];
      var lines = planContent.split('\n');
      var currentStory = null;

      lines.forEach(function(line) {
        // Match story headers like "### [ ] US-001: Story title"
        var storyMatch = line.match(/^###\s*\[[\sx]\]\s*US-\d+:\s*(.+)/i);
        if (storyMatch) {
          if (currentStory) stories.push(currentStory);
          currentStory = { title: storyMatch[1].trim(), tasks: [] };
          return;
        }

        // Match task items
        if (currentStory && line.match(/^-\s*\[[\sx]\]\s*.+/)) {
          var taskMatch = line.match(/^-\s*\[[\sx]\]\s*(.+)/);
          if (taskMatch) {
            currentStory.tasks.push(taskMatch[1].trim());
          }
        }
      });

      if (currentStory) stories.push(currentStory);
      return stories;
    }

    // Step 4: Build configuration
    function renderStep4() {
      var content = document.getElementById('wizard-content');
      content.innerHTML = '\
        <div class="wizard-step-content">\
          <h3>Configure Build</h3>\
          <p>Set up how you want the build to run.</p>\
          \
          <div class="wizard-form-group">\
            <label class="wizard-form-label">Number of Iterations</label>\
            <input \
              type="number" \
              id="wizard-iterations" \
              class="rams-input" \
              style="width: 120px;" \
              min="1" \
              max="100" \
              value="' + wizardState.data.iterations + '"\
            >\
            <p class="wizard-form-help">Each iteration works on one story. Set to the number of stories or higher.</p>\
          </div>\
          \
          <div class="wizard-form-group">\
            <label class="wizard-form-label">Execution Mode</label>\
            <div class="wizard-radio-group">\
              <label class="wizard-radio-option ' + (wizardState.data.executionMode === 'isolated' ? 'selected' : '') + '" onclick="selectRadioOption(this, \'isolated\')">\
                <input type="radio" name="execution-mode" value="isolated" ' + (wizardState.data.executionMode === 'isolated' ? 'checked' : '') + '>\
                <div class="wizard-radio-content">\
                  <div class="wizard-radio-title">Isolated (Recommended)</div>\
                  <div class="wizard-radio-desc">Creates a git worktree and branch. Safe for parallel execution. Changes merged via PR.</div>\
                </div>\
              </label>\
              <label class="wizard-radio-option ' + (wizardState.data.executionMode === 'direct' ? 'selected' : '') + '" onclick="selectRadioOption(this, \'direct\')">\
                <input type="radio" name="execution-mode" value="direct" ' + (wizardState.data.executionMode === 'direct' ? 'checked' : '') + '>\
                <div class="wizard-radio-content">\
                  <div class="wizard-radio-title">Direct to Main</div>\
                  <div class="wizard-radio-desc">Builds directly on main branch. Faster but cannot run multiple streams simultaneously.</div>\
                </div>\
              </label>\
            </div>\
          </div>\
          \
          <div class="wizard-form-group">\
            <label class="wizard-form-label">Agent</label>\
            <select id="wizard-agent" class="rams-input" style="width: 200px;">\
              <option value="claude" ' + (wizardState.data.agent === 'claude' ? 'selected' : '') + '>Claude (Default)</option>\
              <option value="codex" ' + (wizardState.data.agent === 'codex' ? 'selected' : '') + '>Codex</option>\
              <option value="droid" ' + (wizardState.data.agent === 'droid' ? 'selected' : '') + '>Droid</option>\
            </select>\
            <p class="wizard-form-help">The AI agent that will execute the build iterations.</p>\
          </div>\
        </div>\
      ';
    }

    // Handle radio option selection
    function selectRadioOption(label, value) {
      // Update visual selection
      document.querySelectorAll('.wizard-radio-option').forEach(function(opt) {
        opt.classList.remove('selected');
      });
      label.classList.add('selected');

      // Update radio button
      var radio = label.querySelector('input[type="radio"]');
      if (radio) radio.checked = true;

      // Update state
      wizardState.data.executionMode = value;
    }

    // Step 5: Launch confirmation
    function renderStep5() {
      var content = document.getElementById('wizard-content');
      var stories = parsePlanStories(wizardState.data.planContent);

      content.innerHTML = '\
        <div class="wizard-step-content">\
          <h3>Ready to Launch</h3>\
          <p>Review your configuration before starting the build.</p>\
          \
          <div style="background: var(--rams-gray-50); border-radius: 12px; padding: 20px; margin-bottom: 20px;">\
            <h4 style="margin: 0 0 16px; font-size: 16px;">Build Summary</h4>\
            \
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">\
              <div>\
                <div style="font-size: 12px; color: var(--rams-gray-500); text-transform: uppercase; margin-bottom: 4px;">Stream</div>\
                <div style="font-weight: 600;">PRD-' + wizardState.streamId + '</div>\
              </div>\
              <div>\
                <div style="font-size: 12px; color: var(--rams-gray-500); text-transform: uppercase; margin-bottom: 4px;">Stories</div>\
                <div style="font-weight: 600;">' + stories.length + ' stories</div>\
              </div>\
              <div>\
                <div style="font-size: 12px; color: var(--rams-gray-500); text-transform: uppercase; margin-bottom: 4px;">Iterations</div>\
                <div style="font-weight: 600;">' + wizardState.data.iterations + '</div>\
              </div>\
              <div>\
                <div style="font-size: 12px; color: var(--rams-gray-500); text-transform: uppercase; margin-bottom: 4px;">Mode</div>\
                <div style="font-weight: 600;">' + (wizardState.data.executionMode === 'isolated' ? 'Isolated (Worktree)' : 'Direct to Main') + '</div>\
              </div>\
              <div>\
                <div style="font-size: 12px; color: var(--rams-gray-500); text-transform: uppercase; margin-bottom: 4px;">Agent</div>\
                <div style="font-weight: 600;">' + wizardState.data.agent.charAt(0).toUpperCase() + wizardState.data.agent.slice(1) + '</div>\
              </div>\
              <div>\
                <div style="font-size: 12px; color: var(--rams-gray-500); text-transform: uppercase; margin-bottom: 4px;">Est. Time</div>\
                <div style="font-weight: 600;">~' + (stories.length * 3) + '-' + (stories.length * 5) + ' minutes</div>\
              </div>\
            </div>\
          </div>\
          \
          <div style="background: rgba(26, 77, 46, 0.04); border-left: 3px solid var(--rams-accent); padding: 16px; border-radius: 8px;">\
            <strong>What happens next:</strong>\
            <ul style="margin: 8px 0 0 20px; color: var(--rams-gray-700);">\
              ' + (wizardState.data.executionMode === 'isolated' ? '\
              <li>A git worktree will be created at <code>.ralph/worktrees/PRD-' + wizardState.streamId + '/</code></li>\
              <li>A feature branch <code>ralph/PRD-' + wizardState.streamId + '</code> will be created</li>\
              ' : '\
              <li>Build will run directly on your current branch</li>\
              ') + '\
              <li>The agent will work through each story sequentially</li>\
              <li>Progress will be logged to <code>.ralph/PRD-' + wizardState.streamId + '/runs/</code></li>\
            </ul>\
          </div>\
        </div>\
      ';
    }

    // ============================================
    // GENERATION FUNCTIONS
    // ============================================

    // Generate PRD from description
    function generatePRD() {
      wizardState.isGenerating = true;
      updateFooterButtons();

      renderGeneratingState('Generating PRD...', [
        { id: 'create', label: 'Creating stream folder', status: 'pending' },
        { id: 'analyze', label: 'Analyzing requirements', status: 'pending' },
        { id: 'generate', label: 'Generating PRD document', status: 'pending' },
        { id: 'validate', label: 'Validating structure', status: 'pending' }
      ]);

      // Make API call to start wizard
      fetch('/api/stream/wizard/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description: wizardState.data.description })
      })
      .then(function(response) {
        if (!response.ok) {
          return response.json().then(function(data) {
            throw new Error(data.message || 'Failed to start wizard');
          });
        }
        return response.json();
      })
      .then(function(data) {
        if (data.success && data.streamId) {
          wizardState.streamId = data.streamId;
          wizardState.pid = data.pid || null; // Store PID for reliable cancellation
          wizardState.data.prdContent = data.prdContent || '';

          // Connect to SSE for progress updates if available
          if (data.sseEndpoint) {
            connectToSSE(data.sseEndpoint, 'prd');
          } else {
            // No SSE, simulate progress and move to next step
            simulateProgress('prd', function() {
              cleanupGenerationState();
              wizardState.isGenerating = false;
              wizardState.currentStep = 2;
              updateProgressIndicator(2);
              renderStep2();
              updateFooterButtons();
            });
          }
        } else {
          throw new Error(data.message || 'Failed to create stream');
        }
      })
      .catch(function(err) {
        console.error('PRD generation error:', err);
        cleanupGenerationState();
        wizardState.isGenerating = false;
        updateFooterButtons();

        // Check if it's a network/API error
        if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
          showAlert('error', 'Cannot connect to server. Please ensure the server is running.');
          renderStep1();
        } else if (err.message.includes('not found') || err.message.includes('404')) {
          // API endpoint doesn't exist yet - create mock PRD for demo
          showAlert('warning', 'API endpoint not available. Using demo mode.');
          createDemoPRD();
        } else {
          showAlert('error', err.message);
          renderStep1();
        }
      });
    }

    // Create demo PRD when API is not available
    function createDemoPRD() {
      wizardState.streamId = Math.floor(Math.random() * 100) + 1;
      wizardState.data.prdContent = generateDemoPRD(wizardState.data.description);

      simulateProgress('prd', function() {
        cleanupGenerationState();
        wizardState.isGenerating = false;
        wizardState.currentStep = 2;
        updateProgressIndicator(2);
        renderStep2();
        updateFooterButtons();
      });
    }

    // Generate demo PRD content
    function generateDemoPRD(description) {
      return '# Product Requirements Document\n\n' +
        '## Overview\n\n' +
        description + '\n\n' +
        '## User Stories\n\n' +
        '### [ ] US-001: Initial Setup\n\n' +
        '**As a** developer\n' +
        '**I want** to set up the basic structure\n' +
        '**So that** I can build upon it\n\n' +
        '#### Acceptance Criteria\n\n' +
        '- [ ] Basic structure created\n' +
        '- [ ] Dependencies installed\n\n' +
        '### [ ] US-002: Core Implementation\n\n' +
        '**As a** user\n' +
        '**I want** the main functionality\n' +
        '**So that** I can use the feature\n\n' +
        '#### Acceptance Criteria\n\n' +
        '- [ ] Core feature implemented\n' +
        '- [ ] Basic tests added\n\n' +
        '### [ ] US-003: Polish & Testing\n\n' +
        '**As a** user\n' +
        '**I want** a polished experience\n' +
        '**So that** the feature works reliably\n\n' +
        '#### Acceptance Criteria\n\n' +
        '- [ ] Edge cases handled\n' +
        '- [ ] Documentation updated\n';
    }

    // Generate Plan from PRD
    function generatePlan() {
      wizardState.isGenerating = true;
      updateFooterButtons();

      renderGeneratingState('Generating Plan...', [
        { id: 'parse', label: 'Parsing PRD document', status: 'pending' },
        { id: 'breakdown', label: 'Breaking down stories', status: 'pending' },
        { id: 'order', label: 'Ordering tasks', status: 'pending' },
        { id: 'save', label: 'Saving plan', status: 'pending' }
      ]);

      // Update PRD content first if it was edited
      var prdUpdatePromise = Promise.resolve();
      if (wizardState.streamId) {
        prdUpdatePromise = fetch('/api/stream/' + wizardState.streamId + '/prd', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: wizardState.data.prdContent })
        }).catch(function() {
          // Ignore errors - PRD update is optional
          return Promise.resolve();
        });
      }

      prdUpdatePromise.then(function() {
        return fetch('/api/stream/' + wizardState.streamId + '/generate-plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
      })
      .then(function(response) {
        if (!response.ok) {
          return response.json().then(function(data) {
            throw new Error(data.message || 'Failed to generate plan');
          });
        }
        return response.json();
      })
      .then(function(data) {
        if (data.success) {
          wizardState.data.planContent = data.planContent || '';

          if (data.sseEndpoint) {
            connectToSSE(data.sseEndpoint, 'plan');
          } else {
            simulateProgress('plan', function() {
              wizardState.isGenerating = false;
              wizardState.currentStep = 3;
              updateProgressIndicator(3);
              renderStep3();
              updateFooterButtons();
            });
          }
        } else {
          throw new Error(data.message || 'Failed to generate plan');
        }
      })
      .catch(function(err) {
        console.error('Plan generation error:', err);
        wizardState.isGenerating = false;
        updateFooterButtons();

        if (err.message.includes('not found') || err.message.includes('404') || err.message.includes('Failed to fetch')) {
          showAlert('warning', 'API endpoint not available. Using demo mode.');
          createDemoPlan();
        } else {
          showAlert('error', err.message);
          renderStep2();
        }
      });
    }

    // Create demo plan when API is not available
    function createDemoPlan() {
      wizardState.data.planContent = generateDemoPlan(wizardState.data.prdContent);

      simulateProgress('plan', function() {
        wizardState.isGenerating = false;
        wizardState.currentStep = 3;
        updateProgressIndicator(3);
        renderStep3();
        updateFooterButtons();
      });
    }

    // Generate demo plan content from PRD
    function generateDemoPlan(prdContent) {
      // Extract stories from PRD
      var stories = [];
      var storyMatches = prdContent.match(/###\s*\[\s*\]\s*US-\d+:\s*.+/g) || [];
      storyMatches.forEach(function(match) {
        var titleMatch = match.match(/US-\d+:\s*(.+)/);
        if (titleMatch) {
          stories.push(titleMatch[1].trim());
        }
      });

      if (stories.length === 0) {
        stories = ['Setup', 'Implementation', 'Testing'];
      }

      var plan = '# Implementation Plan\n\n';
      plan += '## Stories\n\n';

      stories.forEach(function(story, index) {
        var num = String(index + 1).padStart(3, '0');
        plan += '### [ ] US-' + num + ': ' + story + '\n\n';
        plan += '- [ ] Implement core functionality\n';
        plan += '- [ ] Add error handling\n';
        plan += '- [ ] Write tests\n\n';
      });

      return plan;
    }

    // Launch the build
    function launchBuild() {
      wizardState.isGenerating = true;
      updateFooterButtons();

      renderGeneratingState('Starting Build...', [
        { id: 'init', label: wizardState.data.executionMode === 'isolated' ? 'Creating worktree' : 'Preparing build', status: 'pending' },
        { id: 'start', label: 'Starting agent', status: 'pending' }
      ]);

      // Initialize worktree if isolated mode
      var initPromise = Promise.resolve();
      if (wizardState.data.executionMode === 'isolated') {
        initPromise = fetch('/api/stream/' + wizardState.streamId + '/init', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        }).then(function(response) {
          return response.json();
        }).then(function(data) {
          if (!data.success && !data.message.includes('already')) {
            throw new Error(data.message || 'Failed to initialize worktree');
          }
          updatePhaseStatus('init', 'completed');
        });
      } else {
        setTimeout(function() {
          updatePhaseStatus('init', 'completed');
        }, 500);
      }

      initPromise.then(function() {
        // Start the build
        return fetch('/api/stream/' + wizardState.streamId + '/build', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            iterations: wizardState.data.iterations,
            agent: wizardState.data.agent,
            noWorktree: wizardState.data.executionMode !== 'isolated'
          })
        });
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        updatePhaseStatus('start', 'completed');

        if (data.success) {
          setTimeout(function() {
            wizardState.isGenerating = false;
            closeWizard();
            showAlert('success', 'Build started for PRD-' + wizardState.streamId + '!');
            htmx.trigger(document.body, 'newStreamCreated');
          }, 1000);
        } else {
          throw new Error(data.message || 'Failed to start build');
        }
      })
      .catch(function(err) {
        console.error('Build launch error:', err);
        wizardState.isGenerating = false;
        updateFooterButtons();

        if (err.message.includes('not found') || err.message.includes('404') || err.message.includes('Failed to fetch')) {
          showAlert('warning', 'Build API not available. Stream PRD-' + wizardState.streamId + ' created but build not started.');
          setTimeout(function() {
            closeWizard();
            htmx.trigger(document.body, 'newStreamCreated');
          }, 2000);
        } else {
          showAlert('error', err.message);
          renderStep5();
        }
      });
    }

    // ============================================
    // SSE AND PROGRESS FUNCTIONS
    // ============================================

    // Connect to SSE endpoint for progress updates
    function connectToSSE(endpoint, type) {
      if (wizardState.eventSource) {
        wizardState.eventSource.close();
      }

      wizardState.eventSource = new EventSource(endpoint);

      wizardState.eventSource.addEventListener('phase', function(event) {
        var data = JSON.parse(event.data);
        updatePhaseStatus(data.phase, data.status);
        if (data.progress) {
          updateProgressBar(data.progress);
        }
      });

      wizardState.eventSource.addEventListener('output', function(event) {
        var data = JSON.parse(event.data);
        appendOutput(data.line);
      });

      wizardState.eventSource.addEventListener('complete', function(event) {
        var data = JSON.parse(event.data);
        wizardState.eventSource.close();
        wizardState.eventSource = null;
        cleanupGenerationState();

        if (type === 'prd') {
          wizardState.data.prdContent = data.content || wizardState.data.prdContent;
          wizardState.isGenerating = false;
          wizardState.currentStep = 2;
          updateProgressIndicator(2);
          renderStep2();
        } else if (type === 'plan') {
          wizardState.data.planContent = data.content || wizardState.data.planContent;
          wizardState.isGenerating = false;
          wizardState.currentStep = 3;
          updateProgressIndicator(3);
          renderStep3();
        }
        updateFooterButtons();
      });

      wizardState.eventSource.addEventListener('error', function(event) {
        var errorMsg = 'Generation failed';
        try {
          var data = JSON.parse(event.data);
          errorMsg = data.message || errorMsg;
        } catch (e) {}

        wizardState.eventSource.close();
        wizardState.eventSource = null;
        cleanupGenerationState();
        wizardState.isGenerating = false;
        updateFooterButtons();
        showAlert('error', errorMsg);
        renderCurrentStep();
      });

      wizardState.eventSource.onerror = function() {
        // SSE connection error - fall back to polling or simulation
        if (wizardState.eventSource) {
          wizardState.eventSource.close();
          wizardState.eventSource = null;
        }
        console.warn('SSE connection failed, using simulation');
        simulateProgress(type, function() {
          cleanupGenerationState();
          wizardState.isGenerating = false;
          if (type === 'prd') {
            wizardState.currentStep = 2;
            updateProgressIndicator(2);
            renderStep2();
          } else if (type === 'plan') {
            wizardState.currentStep = 3;
            updateProgressIndicator(3);
            renderStep3();
          }
          updateFooterButtons();
        });
      };
    }

    // Render generating state UI
    function renderGeneratingState(title, phases) {
      var phasesHtml = phases.map(function(phase) {
        return '\
          <div class="wizard-phase" id="phase-' + phase.id + '" data-status="' + phase.status + '">\
            <span class="wizard-phase-icon">' + getPhaseIcon(phase.status) + '</span>\
            <span>' + phase.label + '</span>\
          </div>\
        ';
      }).join('');

      var content = document.getElementById('wizard-content');
      content.innerHTML = '\
        <div class="wizard-generating">\
          <h3>' + title + '</h3>\
          <div class="wizard-progress-bar">\
            <div id="wizard-progress-fill" class="wizard-progress-fill" style="width: 0%"></div>\
          </div>\
          <div class="wizard-phases">\
            ' + phasesHtml + '\
          </div>\
          <div id="wizard-output" class="wizard-output-window">\
            <div class="wizard-output-line">Initializing...</div>\
          </div>\
          <div class="wizard-activity-indicator">\
            <span class="wizard-activity-pulse"></span>\
            <span id="wizard-activity-text">Claude is working...</span>\
          </div>\
          <div class="wizard-time-info">\
            <span id="wizard-elapsed-time">Running for 0s</span>\
            <span class="wizard-time-typical">(typically 1-2 minutes)</span>\
          </div>\
          <div class="wizard-generation-actions">\
            <button class="rams-btn rams-btn-secondary rams-btn-sm" onclick="cancelGeneration()">\
              Cancel Generation\
            </button>\
          </div>\
        </div>\
      ';

      // Start elapsed time timer
      wizardState.generationStartTime = Date.now();
      wizardState.lastOutputTime = Date.now();
      if (wizardState.timerInterval) clearInterval(wizardState.timerInterval);
      wizardState.timerInterval = setInterval(updateElapsedTime, 1000);
    }

    // Get icon for phase status
    function getPhaseIcon(status) {
      switch (status) {
        case 'completed': return '&#10003;';
        case 'active': return '<span class="rams-spinner" style="width: 14px; height: 14px;"></span>';
        case 'error': return '&#10007;';
        default: return '&#9679;';
      }
    }

    // Update phase status
    function updatePhaseStatus(phaseId, status) {
      var phaseEl = document.getElementById('phase-' + phaseId);
      if (phaseEl) {
        phaseEl.dataset.status = status;
        phaseEl.className = 'wizard-phase ' + status;
        var iconEl = phaseEl.querySelector('.wizard-phase-icon');
        if (iconEl) {
          iconEl.innerHTML = getPhaseIcon(status);
        }
      }
    }

    // Update progress bar
    function updateProgressBar(percent) {
      var fill = document.getElementById('wizard-progress-fill');
      if (fill) {
        fill.style.width = percent + '%';
      }
    }

    // Append output line
    function appendOutput(line) {
      var output = document.getElementById('wizard-output');
      if (output) {
        var lineEl = document.createElement('div');
        lineEl.className = 'wizard-output-line';
        lineEl.textContent = line;
        output.appendChild(lineEl);
        output.scrollTop = output.scrollHeight;
      }
      // Track last output time for activity indicator
      wizardState.lastOutputTime = Date.now();
    }

    // Update elapsed time display
    function updateElapsedTime() {
      if (!wizardState.generationStartTime) return;

      var elapsed = Math.floor((Date.now() - wizardState.generationStartTime) / 1000);
      var mins = Math.floor(elapsed / 60);
      var secs = elapsed % 60;
      var display = mins > 0 ? mins + 'm ' + secs + 's' : secs + 's';

      var el = document.getElementById('wizard-elapsed-time');
      if (el) el.textContent = 'Running for ' + display;

      // Stuck detection
      if (elapsed > STUCK_THRESHOLD_SECONDS && !stuckWarningShown) {
        stuckWarningShown = true;
        showStuckWarningDialog(elapsed);
      }

      // Update activity text based on last output
      updateActivityText();
    }

    // Update activity text based on output activity
    function updateActivityText() {
      var text = document.getElementById('wizard-activity-text');
      if (!text) return;

      var lastOutputAge = wizardState.lastOutputTime
        ? Math.floor((Date.now() - wizardState.lastOutputTime) / 1000)
        : 0;

      if (lastOutputAge > 30) {
        text.textContent = 'Waiting for response... (' + lastOutputAge + 's)';
        text.style.color = 'var(--rams-warning)';
      } else {
        text.textContent = 'Claude is working...';
        text.style.color = 'var(--rams-gray-600)';
      }
    }

    // Show stuck warning dialog
    function showStuckWarningDialog(elapsed) {
      var mins = Math.floor(elapsed / 60);
      var overlay = document.getElementById('wizard-overlay');
      if (!overlay) return;

      var dialog = document.createElement('div');
      dialog.className = 'wizard-stuck-dialog';
      dialog.id = 'wizard-stuck-dialog';
      dialog.innerHTML = '\
        <div class="wizard-stuck-content">\
          <div class="wizard-stuck-icon">‚ö†Ô∏è</div>\
          <h4>Generation Taking Longer Than Expected</h4>\
          <p>The generation has been running for ' + mins + ' minutes. This is longer than usual.</p>\
          <p class="wizard-stuck-hint">This could be due to a complex request or a temporary issue with the AI service.</p>\
          <div class="wizard-stuck-actions">\
            <button class="rams-btn rams-btn-secondary" onclick="dismissStuckDialog()">Keep Waiting</button>\
            <button class="rams-btn rams-btn-primary" onclick="cancelGeneration()">Cancel & Retry</button>\
          </div>\
        </div>\
      ';
      overlay.appendChild(dialog);
    }

    // Dismiss stuck warning dialog
    function dismissStuckDialog() {
      var dialog = document.getElementById('wizard-stuck-dialog');
      if (dialog) dialog.remove();
      // Don't show again for this generation
      stuckWarningShown = true;
    }

    // Cancel ongoing generation
    function cancelGeneration() {
      // Stop timer first
      cleanupGenerationState();

      // Use PID-based cancellation if available (more reliable)
      if (wizardState.pid) {
        fetch('/api/wizard/cancel-pid/' + wizardState.pid, {
          method: 'POST'
        }).then(function(r) {
          return r.json();
        }).then(function(data) {
          showAlert('info', 'Generation cancelled');
          wizardState.pid = null;
          closeWizard();
        }).catch(function(e) {
          console.error('Cancel by PID failed:', e);
          showAlert('error', 'Failed to cancel generation');
        });
      } else if (wizardState.streamId) {
        // Fallback to stream-based cancellation
        fetch('/api/stream/' + wizardState.streamId + '/cancel', {
          method: 'POST'
        }).then(function(r) {
          return r.json();
        }).then(function(data) {
          showAlert('info', 'Generation cancelled');
          closeWizard();
        }).catch(function(e) {
          console.error('Cancel failed:', e);
          showAlert('error', 'Failed to cancel generation');
        });
      } else {
        // No process to cancel, just close the wizard
        closeWizard();
      }
    }

    // Cleanup generation state (timer, dialog, etc.)
    function cleanupGenerationState() {
      if (wizardState.timerInterval) {
        clearInterval(wizardState.timerInterval);
        wizardState.timerInterval = null;
      }
      wizardState.generationStartTime = null;
      wizardState.lastOutputTime = null;
      stuckWarningShown = false;

      // Remove stuck dialog if present
      var dialog = document.getElementById('wizard-stuck-dialog');
      if (dialog) dialog.remove();
    }

    // Simulate progress when SSE is not available
    function simulateProgress(type, callback) {
      var phases = type === 'prd' ?
        ['create', 'analyze', 'generate', 'validate'] :
        ['parse', 'breakdown', 'order', 'save'];

      var outputs = type === 'prd' ?
        ['Creating stream folder...', 'Analyzing feature requirements...', 'Generating PRD document...', 'Validating structure...', 'PRD generation complete!'] :
        ['Parsing PRD document...', 'Breaking down into stories...', 'Ordering implementation tasks...', 'Saving plan...', 'Plan generation complete!'];

      var currentPhase = 0;
      var progress = 0;

      function tick() {
        if (currentPhase < phases.length) {
          updatePhaseStatus(phases[currentPhase], 'active');
          appendOutput(outputs[currentPhase]);
          progress = ((currentPhase + 1) / phases.length) * 100;
          updateProgressBar(progress);

          setTimeout(function() {
            updatePhaseStatus(phases[currentPhase], 'completed');
            currentPhase++;
            setTimeout(tick, 300);
          }, 800);
        } else {
          appendOutput(outputs[outputs.length - 1]);
          updateProgressBar(100);
          setTimeout(callback, 500);
        }
      }

      setTimeout(tick, 500);
    }

    // ============================================
    // EDITOR FUNCTIONS
    // ============================================

    // Switch between editor and preview tabs
    function switchEditorTab(tab) {
      var tabs = document.querySelectorAll('.wizard-editor-tab');
      tabs.forEach(function(t) {
        t.classList.remove('active');
      });

      if (tab === 'editor') {
        document.querySelector('.wizard-editor-tab:first-child').classList.add('active');
        document.getElementById('wizard-editor-pane').classList.add('active');
        document.getElementById('wizard-preview-pane').classList.remove('active');
      } else {
        document.querySelector('.wizard-editor-tab:last-child').classList.add('active');
        document.getElementById('wizard-preview-pane').classList.add('active');
        document.getElementById('wizard-editor-pane').classList.remove('active');
        // Update preview when switching to it
        updatePrdPreview();
      }
    }

    // Mark editor as having unsaved changes
    var editorDirty = false;
    function markEditorDirty() {
      editorDirty = true;
      var status = document.getElementById('wizard-editor-status');
      if (status) {
        status.textContent = 'Unsaved changes';
        status.style.color = 'var(--rams-warning)';
      }
    }

    // Save PRD content to backend
    function savePrdContent() {
      if (!wizardState.streamId) {
        showAlert('error', 'No stream ID available');
        return;
      }

      var editor = document.getElementById('wizard-prd-editor');
      if (!editor) {
        showAlert('error', 'Editor not found');
        return;
      }

      var content = editor.value;
      var status = document.getElementById('wizard-editor-status');
      var saveBtn = document.getElementById('wizard-save-btn');

      // Update UI
      if (status) {
        status.textContent = 'Saving...';
        status.style.color = 'var(--rams-gray-500)';
      }
      if (saveBtn) {
        saveBtn.disabled = true;
      }

      // Save to backend
      fetch('/api/stream/' + wizardState.streamId + '/prd', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: content })
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        if (data.success) {
          wizardState.data.prdContent = content;
          editorDirty = false;
          if (status) {
            status.textContent = 'Saved';
            status.style.color = 'var(--rams-accent)';
          }
          showAlert('success', 'PRD saved successfully');
          setTimeout(function() {
            if (status && !editorDirty) {
              status.textContent = 'Ready';
              status.style.color = 'var(--rams-gray-500)';
            }
          }, 2000);
        } else {
          throw new Error(data.message || 'Failed to save');
        }
      })
      .catch(function(err) {
        if (status) {
          status.textContent = 'Save failed';
          status.style.color = 'var(--rams-error)';
        }
        showAlert('error', 'Failed to save PRD: ' + err.message);
      })
      .finally(function() {
        if (saveBtn) {
          saveBtn.disabled = false;
        }
      });
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    // Escape HTML entities
    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================================
    // STREAMS VIEW TOGGLE
    // ============================================

    // Stream View Mode (grid or progress)
    var streamsViewMode = localStorage.getItem("streamsViewMode") || "grid";

    function toggleStreamsView() {
      const toggleBtn = document.getElementById("streams-view-toggle");
      const container = document.getElementById("streams-container");

      streamsViewMode = streamsViewMode === "grid" ? "progress" : "grid";
      localStorage.setItem("streamsViewMode", streamsViewMode);

      // Update button
      if (streamsViewMode === "progress") {
        toggleBtn.innerHTML = "üìã Grid View";
        toggleBtn.title = "Switch to Grid View";
      } else {
        toggleBtn.innerHTML = "üìä Progress View";
        toggleBtn.title = "Switch to Progress View";
      }

      // Preserve showClosed state when switching views
      const showClosed = localStorage.getItem('showClosedStreams') === 'true';
      const baseEndpoint = streamsViewMode === "grid"
        ? "/api/partials/streams"
        : "/api/partials/streams-progress";
      const endpoint = baseEndpoint + (showClosed ? '?showClosed=true' : '');

      container.setAttribute("hx-get", endpoint);
      htmx.process(container);
      htmx.trigger(container, "load");
    }

    // Initialize on page load
    document.addEventListener("DOMContentLoaded", function() {
      const toggleBtn = document.getElementById("streams-view-toggle");
      const container = document.getElementById("streams-container");
      const showClosed = localStorage.getItem('showClosedStreams') === 'true';

      if (streamsViewMode === "progress") {
        toggleBtn.innerHTML = "üìã Grid View";
        toggleBtn.title = "Switch to Grid View";
        const endpoint = "/api/partials/streams-progress" + (showClosed ? '?showClosed=true' : '');
        container.setAttribute("hx-get", endpoint);
      } else if (showClosed) {
        // Also set the grid view endpoint with showClosed if needed
        container.setAttribute("hx-get", "/api/partials/streams?showClosed=true");
      }
    });
  </script>
</body>
</html>
