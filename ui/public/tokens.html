<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ralph CLI - Token Dashboard</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="/js/htmx.min.js"></script>
</head>
<body>
  <!-- Error Toast Container -->
  <div id="error-toast" class="error-toast hidden">
    <div class="error-toast-header">
      <span class="error-toast-title">Error</span>
      <button class="error-toast-dismiss" onclick="dismissErrorToast()">&times;</button>
    </div>
    <div class="error-toast-message" id="error-toast-message"></div>
    <div class="error-toast-actions">
      <button class="retry-button" id="error-toast-retry" onclick="retryLastRequest()">
        <span class="retry-icon">&#8635;</span> Retry
      </button>
    </div>
  </div>

  <header>
    <div class="header-content">
      <h1>Ralph CLI</h1>
      <span class="subtitle">Autonomous Coding Loop</span>
    </div>
    <nav>
      <a href="/">Dashboard</a>
      <a href="/streams.html">Streams</a>
      <a href="/logs.html">Logs</a>
      <a href="/tokens.html" class="active">Tokens</a>
      <a href="/editor.html">Editor</a>
    </nav>
  </header>

  <main>
    <!-- Token Summary Section -->
    <section id="token-summary-section">
      <h2>Token Consumption Overview <span class="htmx-indicator" id="summary-indicator"><span class="loading-spinner"></span></span></h2>
      <div id="token-summary-container"
           hx-get="/api/partials/token-summary"
           hx-trigger="load, every 10s"
           hx-swap="innerHTML"
           hx-indicator="#summary-indicator">
        <div class="loading"><span class="loading-spinner"></span> Loading token summary...</div>
      </div>
    </section>

    <!-- Token by Stream Section -->
    <section id="token-streams-section">
      <h2>Token Usage by Stream <span class="htmx-indicator" id="streams-indicator"><span class="loading-spinner"></span></span></h2>
      <div id="token-streams-container"
           hx-get="/api/partials/token-streams"
           hx-trigger="load, every 10s"
           hx-swap="innerHTML"
           hx-indicator="#streams-indicator">
        <div class="loading"><span class="loading-spinner"></span> Loading stream token data...</div>
      </div>
    </section>

    <!-- Token by Model Section -->
    <section id="token-models-section">
      <h2>Token Usage by Model <span class="htmx-indicator" id="models-indicator"><span class="loading-spinner"></span></span></h2>
      <div id="token-models-container"
           hx-get="/api/partials/token-models"
           hx-trigger="load, every 10s"
           hx-swap="innerHTML"
           hx-indicator="#models-indicator">
        <div class="loading"><span class="loading-spinner"></span> Loading model token data...</div>
      </div>
    </section>
  </main>

  <footer>
    <p>Ralph CLI Web UI &mdash; <span id="status-indicator" hx-get="/api/partials/status-indicator" hx-trigger="load, every 5s" hx-swap="innerHTML">checking...</span></p>
  </footer>

  <script>
    // ============================================
    // Error Handling
    // ============================================

    var lastFailedRequest = null;

    // Show error toast
    function showErrorToast(message, endpoint) {
      console.error('[Error]', message, endpoint ? '(Endpoint: ' + endpoint + ')' : '');
      var toast = document.getElementById('error-toast');
      var messageEl = document.getElementById('error-toast-message');
      var retryBtn = document.getElementById('error-toast-retry');

      messageEl.textContent = message;

      if (lastFailedRequest) {
        retryBtn.style.display = 'inline-flex';
      } else {
        retryBtn.style.display = 'none';
      }

      toast.classList.remove('hidden', 'dismissing');
    }

    // Dismiss error toast
    function dismissErrorToast() {
      var toast = document.getElementById('error-toast');
      toast.classList.add('dismissing');
      setTimeout(function() {
        toast.classList.add('hidden');
        toast.classList.remove('dismissing');
      }, 300);
    }

    // Retry last failed request
    function retryLastRequest() {
      if (lastFailedRequest) {
        var retryBtn = document.getElementById('error-toast-retry');
        retryBtn.classList.add('loading');
        retryBtn.disabled = true;

        var element = lastFailedRequest.element;
        htmx.trigger(element, 'load');

        setTimeout(function() {
          retryBtn.classList.remove('loading');
          retryBtn.disabled = false;
          lastFailedRequest = null;
          dismissErrorToast();
        }, 1000);
      }
    }

    // HTMX error handlers
    document.body.addEventListener('htmx:responseError', function(event) {
      var xhr = event.detail.xhr;
      var path = event.detail.pathInfo ? event.detail.pathInfo.requestPath : 'unknown';

      var message = 'Request failed';
      if (xhr && xhr.status) {
        if (xhr.status === 0) {
          message = 'Unable to connect to server. Check if the server is running.';
        } else if (xhr.status === 404) {
          message = 'Resource not found: ' + path;
        } else if (xhr.status === 500) {
          message = 'Server error occurred. Please try again.';
          try {
            var response = JSON.parse(xhr.responseText);
            if (response.message) {
              message = response.message;
            }
          } catch (e) {}
        } else {
          message = 'Request failed with status ' + xhr.status;
        }
      }

      lastFailedRequest = { element: event.target };
      showErrorToast(message, path);
    });

    document.body.addEventListener('htmx:sendError', function(event) {
      var path = event.detail.pathInfo ? event.detail.pathInfo.requestPath : 'unknown';
      console.error('[HTMX Send Error] Failed to send request:', path, event.detail);
      lastFailedRequest = { element: event.target };
      showErrorToast('Network error: Unable to send request. Check your connection.', path);
    });

    document.body.addEventListener('htmx:timeout', function(event) {
      var path = event.detail.pathInfo ? event.detail.pathInfo.requestPath : 'unknown';
      console.error('[HTMX Timeout] Request timed out:', path);
      lastFailedRequest = { element: event.target };
      showErrorToast('Request timed out. The server may be busy.', path);
    });

    // Auto-dismiss error toast after 10 seconds
    setInterval(function() {
      var toast = document.getElementById('error-toast');
      if (!toast.classList.contains('hidden') && !lastFailedRequest) {
        dismissErrorToast();
      }
    }, 10000);
  </script>
</body>
</html>
