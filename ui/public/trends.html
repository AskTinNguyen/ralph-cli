<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ralph CLI - Success Rate Trends</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <script src="/js/htmx.min.js"></script>
    <script src="/js/chart.min.js"></script>
  </head>
  <body>
    <!-- Error Toast Container -->
    <div id="error-toast" class="error-toast hidden">
      <div class="error-toast-header">
        <span class="error-toast-title">Error</span>
        <button class="error-toast-dismiss" onclick="dismissErrorToast()">&times;</button>
      </div>
      <div class="error-toast-message" id="error-toast-message"></div>
      <div class="error-toast-actions">
        <button class="retry-button" id="error-toast-retry" onclick="retryLastRequest()">
          <span class="retry-icon">&#8635;</span> Retry
        </button>
      </div>
    </div>

    <header>
      <div class="header-content">
        <h1>Ralph CLI</h1>
        <span class="subtitle">Autonomous Coding Loop</span>
      </div>
      <nav>
        <a href="/">Dashboard</a>
        <a href="/streams.html">Streams</a>
        <a href="/logs.html">Logs</a>
        <a href="/tokens.html">Tokens</a>
        <a href="/trends.html" class="active">Trends</a>
        <a href="/editor.html">Editor</a>
      </nav>
    </header>

    <main>
      <!-- Success Rate Summary Section -->
      <section id="success-rate-summary-section">
        <h2>
          Success Rate Overview
          <span class="htmx-indicator" id="summary-indicator">
            <span class="loading-spinner"></span>
          </span>
        </h2>
        <div
          id="success-rate-summary-container"
          hx-get="/api/partials/success-rate-chart"
          hx-trigger="load"
          hx-swap="innerHTML"
          hx-indicator="#summary-indicator"
        >
          <div class="loading"><span class="loading-spinner"></span> Loading success rate data...</div>
        </div>
      </section>

      <!-- Success Rate Chart Section -->
      <section id="success-rate-chart-section">
        <div class="trend-chart-header">
          <h2>Success Rate Timeline</h2>
          <div class="trend-chart-controls">
            <div class="control-group">
              <label for="trend-period">Period:</label>
              <select id="trend-period" onchange="updateSuccessRateChart()">
                <option value="7d" selected>Last 7 days</option>
                <option value="30d">Last 30 days</option>
              </select>
            </div>
            <div
              id="trend-filters-container"
              hx-get="/api/partials/success-rate-filters"
              hx-trigger="load"
              hx-swap="innerHTML"
            >
              <!-- Filters loaded via HTMX -->
            </div>
          </div>
        </div>
        <div class="trend-chart-container">
          <canvas id="success-rate-chart"></canvas>
        </div>
        <div class="trend-chart-legend">
          <div class="legend-item">
            <span class="legend-color" style="background: #10b981"></span>
            <span>Success Rate (%)</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background: #3b82f6"></span>
            <span>Passed Runs</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background: #ef4444"></span>
            <span>Failed Runs</span>
          </div>
        </div>
      </section>

      <!-- Week-over-Week Comparison Section -->
      <section id="week-comparison-section">
        <h2>Week-over-Week Comparison</h2>
        <div id="week-comparison-container">
          <div class="comparison-cards">
            <div class="comparison-card" id="this-week-card">
              <h3>This Week</h3>
              <div class="comparison-value" id="this-week-value">--</div>
              <div class="comparison-runs" id="this-week-runs">-- runs</div>
            </div>
            <div class="comparison-card" id="comparison-delta-card">
              <h3>Change</h3>
              <div class="comparison-delta" id="comparison-delta">--</div>
              <div class="comparison-direction" id="comparison-direction">vs last week</div>
            </div>
            <div class="comparison-card" id="last-week-card">
              <h3>Last Week</h3>
              <div class="comparison-value" id="last-week-value">--</div>
              <div class="comparison-runs" id="last-week-runs">-- runs</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Significant Changes Section -->
      <section id="significant-changes-section">
        <h2>Significant Changes</h2>
        <p class="section-description">
          Days with 10%+ change in success rate are highlighted to help identify patterns.
        </p>
        <div id="significant-changes-container">
          <div class="no-data-message">No significant changes detected in the selected period.</div>
        </div>
      </section>

      <!-- Cost Trends Section -->
      <section id="cost-trends-section">
        <h2>
          Cost Trends
          <span class="htmx-indicator" id="cost-indicator">
            <span class="loading-spinner"></span>
          </span>
        </h2>
        <div
          id="cost-summary-container"
          hx-get="/api/partials/cost-chart"
          hx-trigger="load"
          hx-swap="innerHTML"
          hx-indicator="#cost-indicator"
        >
          <div class="loading"><span class="loading-spinner"></span> Loading cost data...</div>
        </div>
      </section>

      <!-- Cost Chart Section -->
      <section id="cost-chart-section">
        <div class="trend-chart-header">
          <h2>Cost Timeline</h2>
          <div class="trend-chart-controls">
            <div class="control-group">
              <label for="cost-period">Period:</label>
              <select id="cost-period" onchange="updateCostChart()">
                <option value="7d">Last 7 days</option>
                <option value="30d" selected>Last 30 days</option>
              </select>
            </div>
            <div class="control-group">
              <label for="cost-group-by">Group by:</label>
              <select id="cost-group-by" onchange="updateCostChart()">
                <option value="day" selected>Day</option>
                <option value="week">Week</option>
              </select>
            </div>
            <div
              id="cost-filters-container"
              hx-get="/api/partials/cost-filters"
              hx-trigger="load"
              hx-swap="innerHTML"
            >
              <!-- Filters loaded via HTMX -->
            </div>
          </div>
        </div>
        <div class="trend-chart-container">
          <canvas id="cost-chart"></canvas>
        </div>
        <div class="trend-chart-legend">
          <div class="legend-item">
            <span class="legend-color" style="background: #8b5cf6"></span>
            <span>Daily Cost ($)</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background: #f59e0b"></span>
            <span>Cumulative Cost ($)</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background: #06b6d4"></span>
            <span>Cost per Story ($)</span>
          </div>
          <div class="legend-item legend-budget hidden" id="budget-legend">
            <span class="legend-color" style="background: #ef4444; border-style: dashed"></span>
            <span>Daily Budget ($)</span>
          </div>
        </div>
      </section>

      <!-- Model Cost Breakdown Section -->
      <section id="model-breakdown-section">
        <h2>Cost by Model</h2>
        <p class="section-description">
          Breakdown of costs by AI model to understand spending patterns.
        </p>
        <div class="model-breakdown-container">
          <div class="model-chart-wrapper">
            <canvas id="model-breakdown-chart"></canvas>
          </div>
          <div id="model-breakdown-stats">
            <div class="no-data-message">Loading model breakdown...</div>
          </div>
        </div>
      </section>

      <!-- Cost per Story Section -->
      <section id="story-cost-section">
        <h2>Cost per Story</h2>
        <p class="section-description">
          Track how much each story costs over time.
        </p>
        <div id="story-cost-container">
          <div class="no-data-message">Loading story costs...</div>
        </div>
      </section>
    </main>

    <footer>
      <p>
        Ralph CLI Web UI &mdash;
        <span
          id="status-indicator"
          hx-get="/api/partials/status-indicator"
          hx-trigger="load, every 5s"
          hx-swap="innerHTML"
          >checking...</span
        >
      </p>
    </footer>

    <script>
      // ============================================
      // Error Handling
      // ============================================

      var lastFailedRequest = null;

      function showErrorToast(message, endpoint) {
        console.error("[Error]", message, endpoint ? "(Endpoint: " + endpoint + ")" : "");
        var toast = document.getElementById("error-toast");
        var messageEl = document.getElementById("error-toast-message");
        var retryBtn = document.getElementById("error-toast-retry");

        messageEl.textContent = message;

        if (lastFailedRequest) {
          retryBtn.style.display = "inline-flex";
        } else {
          retryBtn.style.display = "none";
        }

        toast.classList.remove("hidden", "dismissing");
      }

      function dismissErrorToast() {
        var toast = document.getElementById("error-toast");
        toast.classList.add("dismissing");
        setTimeout(function () {
          toast.classList.add("hidden");
          toast.classList.remove("dismissing");
        }, 300);
      }

      function retryLastRequest() {
        if (lastFailedRequest) {
          var retryBtn = document.getElementById("error-toast-retry");
          retryBtn.classList.add("loading");
          retryBtn.disabled = true;

          var element = lastFailedRequest.element;
          htmx.trigger(element, "load");

          setTimeout(function () {
            retryBtn.classList.remove("loading");
            retryBtn.disabled = false;
            lastFailedRequest = null;
            dismissErrorToast();
          }, 1000);
        }
      }

      document.body.addEventListener("htmx:responseError", function (event) {
        var xhr = event.detail.xhr;
        var path = event.detail.pathInfo ? event.detail.pathInfo.requestPath : "unknown";

        var message = "Request failed";
        if (xhr && xhr.status) {
          if (xhr.status === 0) {
            message = "Unable to connect to server. Check if the server is running.";
          } else if (xhr.status === 404) {
            message = "Resource not found: " + path;
          } else if (xhr.status === 500) {
            message = "Server error occurred. Please try again.";
            try {
              var response = JSON.parse(xhr.responseText);
              if (response.message) {
                message = response.message;
              }
            } catch (e) {}
          } else {
            message = "Request failed with status " + xhr.status;
          }
        }

        lastFailedRequest = { element: event.target };
        showErrorToast(message, path);
      });

      setInterval(function () {
        var toast = document.getElementById("error-toast");
        if (!toast.classList.contains("hidden") && !lastFailedRequest) {
          dismissErrorToast();
        }
      }, 10000);

      // ============================================
      // Success Rate Chart
      // ============================================

      var successRateChart = null;
      var chartData = null;

      function initSuccessRateChart() {
        var ctx = document.getElementById("success-rate-chart");
        if (!ctx) return;

        var isDarkMode =
          document.body.classList.contains("dark-mode") ||
          window.matchMedia("(prefers-color-scheme: dark)").matches;

        var gridColor = isDarkMode ? "rgba(255, 255, 255, 0.1)" : "rgba(0, 0, 0, 0.1)";
        var textColor = isDarkMode ? "#e5e7eb" : "#374151";

        successRateChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Success Rate (%)",
                data: [],
                borderColor: "#10b981",
                backgroundColor: "rgba(16, 185, 129, 0.1)",
                fill: true,
                tension: 0.3,
                yAxisID: "y",
                pointRadius: 5,
                pointHoverRadius: 7,
              },
              {
                label: "Passed",
                data: [],
                borderColor: "#3b82f6",
                backgroundColor: "transparent",
                fill: false,
                tension: 0.3,
                yAxisID: "y1",
                pointRadius: 4,
                pointHoverRadius: 6,
              },
              {
                label: "Failed",
                data: [],
                borderColor: "#ef4444",
                backgroundColor: "transparent",
                fill: false,
                tension: 0.3,
                yAxisID: "y1",
                pointRadius: 4,
                pointHoverRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                backgroundColor: isDarkMode ? "#1f2937" : "#ffffff",
                titleColor: textColor,
                bodyColor: textColor,
                borderColor: gridColor,
                borderWidth: 1,
                padding: 12,
                callbacks: {
                  label: function (context) {
                    var label = context.dataset.label || "";
                    var value = context.parsed.y;
                    if (label === "Success Rate (%)") {
                      return label + ": " + value + "%";
                    }
                    return label + ": " + value;
                  },
                },
              },
            },
            scales: {
              x: {
                display: true,
                grid: {
                  color: gridColor,
                },
                ticks: {
                  color: textColor,
                  maxTicksLimit: 10,
                },
              },
              y: {
                type: "linear",
                display: true,
                position: "left",
                min: 0,
                max: 100,
                title: {
                  display: true,
                  text: "Success Rate (%)",
                  color: textColor,
                },
                grid: {
                  color: gridColor,
                },
                ticks: {
                  color: textColor,
                  callback: function (value) {
                    return value + "%";
                  },
                },
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",
                min: 0,
                title: {
                  display: true,
                  text: "Run Count",
                  color: textColor,
                },
                grid: {
                  drawOnChartArea: false,
                },
                ticks: {
                  color: textColor,
                },
              },
            },
          },
        });
      }

      function updateSuccessRateChart() {
        var period = document.getElementById("trend-period").value;
        var prdFilter = document.getElementById("trend-prd-filter");
        var agentFilter = document.getElementById("trend-agent-filter");

        var prd = prdFilter ? prdFilter.value : "all";
        var agent = agentFilter ? agentFilter.value : "all";

        var url = "/api/trends/success-rate?period=" + encodeURIComponent(period);
        if (prd && prd !== "all") {
          url += "&prd=" + encodeURIComponent(prd);
        }
        if (agent && agent !== "all") {
          url += "&agent=" + encodeURIComponent(agent);
        }

        fetch(url)
          .then(function (response) {
            if (!response.ok) throw new Error("Failed to fetch trend data");
            return response.json();
          })
          .then(function (data) {
            chartData = data;
            renderChart(data);
            updateComparison(data.weekOverWeek);
            updateSignificantChanges(data.trends.significantChanges);
            updateSummary(data.trends);
          })
          .catch(function (error) {
            console.error("Error fetching chart data:", error);
          });
      }

      function renderChart(data) {
        if (!successRateChart || !data.chartData) return;

        successRateChart.data.labels = data.chartData.labels;
        successRateChart.data.datasets[0].data = data.chartData.datasets[0].data;
        successRateChart.data.datasets[1].data = data.chartData.datasets[1].data;
        successRateChart.data.datasets[2].data = data.chartData.datasets[2].data;

        // Add annotations for significant changes
        if (data.chartData.significantChanges && data.chartData.significantChanges.length > 0) {
          // Highlight points with significant changes
          var pointBackgroundColors = data.chartData.datasets[0].data.map(function (_, i) {
            var change = data.chartData.significantChanges.find(function (c) {
              return c.x === i;
            });
            if (change) {
              return change.direction === "improved" ? "#10b981" : "#ef4444";
            }
            return "#10b981";
          });

          var pointRadii = data.chartData.datasets[0].data.map(function (_, i) {
            var change = data.chartData.significantChanges.find(function (c) {
              return c.x === i;
            });
            return change ? 8 : 5;
          });

          successRateChart.data.datasets[0].pointBackgroundColor = pointBackgroundColors;
          successRateChart.data.datasets[0].pointRadius = pointRadii;
        }

        successRateChart.update("active");
      }

      function updateComparison(weekOverWeek) {
        if (!weekOverWeek) return;

        var thisWeekValue = document.getElementById("this-week-value");
        var thisWeekRuns = document.getElementById("this-week-runs");
        var lastWeekValue = document.getElementById("last-week-value");
        var lastWeekRuns = document.getElementById("last-week-runs");
        var deltaEl = document.getElementById("comparison-delta");
        var deltaCard = document.getElementById("comparison-delta-card");

        thisWeekValue.textContent =
          weekOverWeek.thisWeek.successRate !== null
            ? weekOverWeek.thisWeek.successRate + "%"
            : "N/A";
        thisWeekRuns.textContent = weekOverWeek.thisWeek.totalRuns + " runs";

        lastWeekValue.textContent =
          weekOverWeek.lastWeek.successRate !== null
            ? weekOverWeek.lastWeek.successRate + "%"
            : "N/A";
        lastWeekRuns.textContent = weekOverWeek.lastWeek.totalRuns + " runs";

        if (weekOverWeek.delta !== null) {
          var sign = weekOverWeek.delta > 0 ? "+" : "";
          deltaEl.textContent = sign + weekOverWeek.delta + "%";
          deltaCard.className = "comparison-card " + weekOverWeek.direction;
        } else {
          deltaEl.textContent = "N/A";
          deltaCard.className = "comparison-card stable";
        }
      }

      function updateSignificantChanges(changes) {
        var container = document.getElementById("significant-changes-container");

        if (!changes || changes.length === 0) {
          container.innerHTML =
            '<div class="no-data-message">No significant changes detected in the selected period.</div>';
          return;
        }

        var html = '<div class="changes-list">';
        changes.forEach(function (change) {
          var icon = change.direction === "improved" ? "&#8593;" : "&#8595;";
          var changeClass = change.direction;
          var date = new Date(change.date);
          var formattedDate = date.toLocaleDateString("en-US", {
            weekday: "short",
            month: "short",
            day: "numeric",
          });

          html +=
            '<div class="change-item ' +
            changeClass +
            '">' +
            '<span class="change-icon">' +
            icon +
            "</span>" +
            '<div class="change-details">' +
            '<span class="change-date">' +
            formattedDate +
            "</span>" +
            '<span class="change-rates">' +
            change.previousRate +
            "% &rarr; " +
            change.currentRate +
            "%" +
            "</span>" +
            "</div>" +
            '<span class="change-delta ' +
            changeClass +
            '">' +
            (change.delta > 0 ? "+" : "") +
            change.delta +
            "%" +
            "</span>" +
            "</div>";
        });
        html += "</div>";

        container.innerHTML = html;
      }

      function updateSummary(trends) {
        // Update HTMX partial with current filters
        var period = document.getElementById("trend-period").value;
        var prdFilter = document.getElementById("trend-prd-filter");
        var agentFilter = document.getElementById("trend-agent-filter");

        var prd = prdFilter ? prdFilter.value : "all";
        var agent = agentFilter ? agentFilter.value : "all";

        var url = "/api/partials/success-rate-chart?period=" + encodeURIComponent(period);
        if (prd && prd !== "all") {
          url += "&prd=" + encodeURIComponent(prd);
        }
        if (agent && agent !== "all") {
          url += "&agent=" + encodeURIComponent(agent);
        }

        htmx.ajax("GET", url, "#success-rate-summary-container");
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function () {
        initSuccessRateChart();
        updateSuccessRateChart();
        initCostChart();
        initModelBreakdownChart();
        updateCostChart();
      });

      // ============================================
      // Cost Chart
      // ============================================

      var costChart = null;
      var modelBreakdownChart = null;
      var costData = null;

      function initCostChart() {
        var ctx = document.getElementById("cost-chart");
        if (!ctx) return;

        var isDarkMode =
          document.body.classList.contains("dark-mode") ||
          window.matchMedia("(prefers-color-scheme: dark)").matches;

        var gridColor = isDarkMode ? "rgba(255, 255, 255, 0.1)" : "rgba(0, 0, 0, 0.1)";
        var textColor = isDarkMode ? "#e5e7eb" : "#374151";

        costChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Daily Cost ($)",
                data: [],
                borderColor: "#8b5cf6",
                backgroundColor: "rgba(139, 92, 246, 0.1)",
                fill: true,
                tension: 0.3,
                yAxisID: "y",
              },
              {
                label: "Cumulative Cost ($)",
                data: [],
                borderColor: "#f59e0b",
                backgroundColor: "transparent",
                fill: false,
                tension: 0.3,
                yAxisID: "y1",
              },
              {
                label: "Cost per Story ($)",
                data: [],
                borderColor: "#06b6d4",
                backgroundColor: "transparent",
                fill: false,
                tension: 0.3,
                yAxisID: "y",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                backgroundColor: isDarkMode ? "#1f2937" : "#ffffff",
                titleColor: textColor,
                bodyColor: textColor,
                borderColor: gridColor,
                borderWidth: 1,
                padding: 12,
                callbacks: {
                  label: function (context) {
                    var label = context.dataset.label || "";
                    var value = context.parsed.y;
                    return label + ": $" + value.toFixed(4);
                  },
                },
              },
            },
            scales: {
              x: {
                display: true,
                grid: {
                  color: gridColor,
                },
                ticks: {
                  color: textColor,
                  maxTicksLimit: 10,
                },
              },
              y: {
                type: "linear",
                display: true,
                position: "left",
                min: 0,
                title: {
                  display: true,
                  text: "Daily Cost ($)",
                  color: textColor,
                },
                grid: {
                  color: gridColor,
                },
                ticks: {
                  color: textColor,
                  callback: function (value) {
                    return "$" + value.toFixed(2);
                  },
                },
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",
                min: 0,
                title: {
                  display: true,
                  text: "Cumulative Cost ($)",
                  color: textColor,
                },
                grid: {
                  drawOnChartArea: false,
                },
                ticks: {
                  color: textColor,
                  callback: function (value) {
                    return "$" + value.toFixed(2);
                  },
                },
              },
            },
          },
        });
      }

      function initModelBreakdownChart() {
        var ctx = document.getElementById("model-breakdown-chart");
        if (!ctx) return;

        var isDarkMode =
          document.body.classList.contains("dark-mode") ||
          window.matchMedia("(prefers-color-scheme: dark)").matches;

        var textColor = isDarkMode ? "#e5e7eb" : "#374151";

        modelBreakdownChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: [],
            datasets: [
              {
                data: [],
                backgroundColor: ["#8b5cf6", "#3b82f6", "#10b981", "#f59e0b", "#ef4444"],
                borderColor: ["#8b5cf6", "#3b82f6", "#10b981", "#f59e0b", "#ef4444"],
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: "right",
                labels: {
                  color: textColor,
                  padding: 15,
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    var label = context.label || "";
                    var value = context.parsed;
                    return label + ": $" + value.toFixed(4);
                  },
                },
              },
            },
          },
        });
      }

      function updateCostChart() {
        var period = document.getElementById("cost-period").value;
        var groupBy = document.getElementById("cost-group-by").value;
        var prdFilter = document.getElementById("cost-prd-filter");
        var modelFilter = document.getElementById("cost-model-filter");
        var budgetInput = document.getElementById("cost-budget-input");

        var prd = prdFilter ? prdFilter.value : "all";
        var model = modelFilter ? modelFilter.value : "all";
        var budget = budgetInput ? budgetInput.value : "";

        var url =
          "/api/trends/cost?period=" +
          encodeURIComponent(period) +
          "&groupBy=" +
          encodeURIComponent(groupBy);

        if (prd && prd !== "all") {
          url += "&prd=" + encodeURIComponent(prd);
        }
        if (model && model !== "all") {
          url += "&model=" + encodeURIComponent(model);
        }
        if (budget && parseFloat(budget) > 0) {
          url += "&budget=" + encodeURIComponent(budget);
        }

        fetch(url)
          .then(function (response) {
            if (!response.ok) throw new Error("Failed to fetch cost data");
            return response.json();
          })
          .then(function (data) {
            costData = data;
            renderCostChart(data);
            renderModelBreakdown(data);
            renderStoryCosts(data.trends.storyTrends);
            updateCostSummary(data.trends, period);

            // Show/hide budget legend
            var budgetLegend = document.getElementById("budget-legend");
            if (budgetLegend) {
              if (budget && parseFloat(budget) > 0) {
                budgetLegend.classList.remove("hidden");
              } else {
                budgetLegend.classList.add("hidden");
              }
            }
          })
          .catch(function (error) {
            console.error("Error fetching cost data:", error);
          });
      }

      function renderCostChart(data) {
        if (!costChart || !data.chartData) return;

        costChart.data.labels = data.chartData.labels;
        costChart.data.datasets[0].data = data.chartData.datasets[0].data;
        costChart.data.datasets[1].data = data.chartData.datasets[1].data;
        costChart.data.datasets[2].data = data.chartData.datasets[2].data;

        // Handle budget line (4th dataset if present)
        if (data.chartData.datasets.length > 3) {
          if (costChart.data.datasets.length < 4) {
            costChart.data.datasets.push({
              label: "Daily Budget ($)",
              data: data.chartData.datasets[3].data,
              borderColor: "#ef4444",
              backgroundColor: "transparent",
              fill: false,
              tension: 0,
              borderDash: [5, 5],
              yAxisID: "y",
            });
          } else {
            costChart.data.datasets[3].data = data.chartData.datasets[3].data;
          }
        } else if (costChart.data.datasets.length > 3) {
          costChart.data.datasets.splice(3, 1);
        }

        costChart.update("active");
      }

      function renderModelBreakdown(data) {
        if (!modelBreakdownChart || !data.modelBreakdownChart) return;

        modelBreakdownChart.data.labels = data.modelBreakdownChart.labels;
        modelBreakdownChart.data.datasets[0].data = data.modelBreakdownChart.datasets[0].data;
        modelBreakdownChart.data.datasets[0].backgroundColor =
          data.modelBreakdownChart.datasets[0].backgroundColor;
        modelBreakdownChart.data.datasets[0].borderColor =
          data.modelBreakdownChart.datasets[0].borderColor;

        modelBreakdownChart.update("active");

        // Update model stats
        var statsContainer = document.getElementById("model-breakdown-stats");
        if (!statsContainer || !data.trends.byModel) return;

        var models = Object.entries(data.trends.byModel);
        if (models.length === 0) {
          statsContainer.innerHTML =
            '<div class="no-data-message">No model data available.</div>';
          return;
        }

        var html = '<div class="model-stats-list">';
        models.forEach(function (entry) {
          var model = entry[0];
          var stats = entry[1];
          html +=
            '<div class="model-stat-item">' +
            '<span class="model-name">' +
            model +
            "</span>" +
            '<span class="model-cost">$' +
            stats.cost.toFixed(4) +
            "</span>" +
            '<span class="model-runs">' +
            stats.runs +
            " runs</span>" +
            "</div>";
        });
        html += "</div>";

        statsContainer.innerHTML = html;
      }

      function renderStoryCosts(storyTrends) {
        var container = document.getElementById("story-cost-container");

        if (!storyTrends || storyTrends.length === 0) {
          container.innerHTML =
            '<div class="no-data-message">No story cost data available.</div>';
          return;
        }

        // Sort by cost descending
        var sorted = storyTrends.slice().sort(function (a, b) {
          return b.cost - a.cost;
        });

        var html = '<div class="story-cost-list">';
        sorted.slice(0, 10).forEach(function (story) {
          html +=
            '<div class="story-cost-item">' +
            '<span class="story-id">' +
            story.storyId +
            "</span>" +
            '<span class="story-date">' +
            story.date +
            "</span>" +
            '<span class="story-cost">$' +
            story.cost.toFixed(4) +
            "</span>" +
            '<span class="story-runs">' +
            story.runs +
            " runs</span>" +
            "</div>";
        });
        html += "</div>";

        if (sorted.length > 10) {
          html +=
            '<div class="story-cost-more">Showing top 10 of ' +
            sorted.length +
            " stories</div>";
        }

        container.innerHTML = html;
      }

      function updateCostSummary(trends, period) {
        var url = "/api/partials/cost-chart?period=" + encodeURIComponent(period);

        var prdFilter = document.getElementById("cost-prd-filter");
        var modelFilter = document.getElementById("cost-model-filter");
        var budgetInput = document.getElementById("cost-budget-input");

        if (prdFilter && prdFilter.value !== "all") {
          url += "&prd=" + encodeURIComponent(prdFilter.value);
        }
        if (modelFilter && modelFilter.value !== "all") {
          url += "&model=" + encodeURIComponent(modelFilter.value);
        }
        if (budgetInput && budgetInput.value) {
          url += "&budget=" + encodeURIComponent(budgetInput.value);
        }

        htmx.ajax("GET", url, "#cost-summary-container");
      }
    </script>
  </body>
</html>
